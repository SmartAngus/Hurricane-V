{"ast":null,"code":"var _jsxFileName = \"/Users/majy/work/bici/code/editor-demo/src/features/editor/common/CanvasContent.tsx\";\n\n/**\n * @file 处理画布内的操作\n */\nimport * as React from \"react\";\nimport * as _ from \"lodash\";\nimport * as uuid from \"uuid\";\nimport { ReScreen, BaseLayout } from \"regraph-next\";\nimport { zoomIdentity } from \"d3-zoom\";\nimport { Menu } from \"antd\";\nimport { EditorNode } from \"./EditorNode\";\nimport { EditorGroup } from \"./EditorGroup\";\nimport { EditorEdges } from \"./EditorEdges\";\nimport { ContextMenu } from \"./ContextMenu\";\nimport { CONNECTOR, OperateType, NODE_WIDTH, NODE_HEIGHT, LINK_AREA } from \"../constants/defines\";\nimport { findNearbyNode } from \"../utils/find\";\nimport { calcLinkPosition } from \"../utils/calc\";\nimport { checkNodeIsOverGroup } from \"../utils/layout\";\nimport { exitFullscreen, launchFullscreen, isFull, getOffset } from \"./utils\";\nconst defaultCavasProps = {\n  width: 1366,\n  height: 768\n};\nexport default class CanvasContent extends React.Component {\n  constructor(props) {\n    super(props);\n    this.nodesContainerRef = void 0;\n    this.container = void 0;\n    this.screenWidth = void 0;\n    this.screenHeight = void 0;\n    this.handleApplyTransform = void 0;\n    this.handleResize = void 0;\n    this.handleAdapt = void 0;\n    this.handleResizeTo = void 0;\n\n    this.openContainerMenu = event => {\n      event.preventDefault();\n    };\n\n    this.toggleDragGroup = isDraggingGroup => {\n      if (isDraggingGroup) {\n        window.addEventListener(\"mousemove\", this.onDragGroupMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragGroupMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragGroupMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragGroupMouseUp);\n      }\n    };\n\n    this.toggleDragNode = isDraggingNode => {\n      if (isDraggingNode) {\n        window.addEventListener(\"mousemove\", this.onDragNodeMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragNodeMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragNodeMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragNodeMouseUp);\n      }\n    };\n\n    this.toggleDragLink = isDraggingLink => {\n      if (isDraggingLink) {\n        window.addEventListener(\"mousemove\", this.onDragLinkMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragLinkMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragLinkMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragLinkMouseUp);\n      }\n    };\n\n    this.onDragLinkMouseMove = event => {\n      event.stopPropagation();\n      event.preventDefault();\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current); // 计算滚动条的位置\n\n      const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n      const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n      const screenX = event.clientX - offsetLeft + scrollLeft;\n      const screenY = event.clientY - offsetTop + scrollTop;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      this.setState(preState => {\n        const {\n          dragLink\n        } = preState;\n        return {\n          dragLink: { ...dragLink,\n            x: (screenX - x) / k,\n            y: (screenY - y) / k\n          }\n        };\n      });\n    };\n\n    this.onNodesContainerMouseDown = event => {\n      console.log(\"onNodesContainerMouseDown\");\n      event.stopPropagation();\n      const {\n        nodes,\n        groups\n      } = this.props; // 如果画布中有节点\n\n      if (nodes && nodes.length > 0) {\n        const currentNode = _.find(nodes, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        const type = event.target.dataset && event.target.dataset.type;\n        const position = event.target.dataset && event.target.dataset.position; // 如果当前选中的是节点\n\n        console.log(\"currentNode==\", currentNode);\n\n        if (currentNode) {\n          if (type === \"edge\" && position) {\n            /** 拖拽连线 */\n            this.onDragLinkMouseDown(currentNode, position);\n            return;\n          } else if (type === \"resize\") {\n            return;\n          } else {\n            /** 拖拽节点，排除resize节点 */\n            this.onDragNodeMouseDown(currentNode, event);\n          }\n        }\n      }\n\n      if (groups && groups.length > 0) {\n        const currentGroup = _.find(groups, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        this.onDragGroupMouseDown(currentGroup, event);\n      }\n    };\n\n    this.onContainerMouseDown = event => {\n      // event.stopPropagation();\n      // 过滤掉节点和边\n      const path = event.path;\n      const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n\n      if (!isNodeOrLink) {\n        // 清空高亮的节点和边\n        this.handleClearActive();\n      }\n    };\n\n    this.onNodesContainerMouseMove = event => {\n      event.preventDefault();\n      const path = event.path;\n      const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n      const {\n        nodes\n      } = this.props;\n\n      if (nodes && nodes.length > 0) {\n        const currentNode = _.find(nodes, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        if (currentNode) {\n          if (isNodeOrLink) {\n            this.setState({\n              currentHoverNode: currentNode.id\n            });\n          } else {\n            this.setState({\n              currentHoverNode: \"\"\n            });\n          }\n        }\n      }\n    };\n\n    this.onDragLinkMouseDown = (node, position) => {\n      const {\n        x,\n        y\n      } = calcLinkPosition(node, position);\n      this.setState({\n        isDraggingLink: true,\n        dragLink: {\n          originId: node.id,\n          originX: x,\n          originY: y,\n          x,\n          y\n        },\n        sourcePos: position\n      });\n    };\n\n    this.onDragLinkMouseUp = event => {\n      const {\n        setLinks,\n        links,\n        nodes\n      } = this.props;\n      const {\n        dragLink\n      } = this.state;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current); // 计算滚动条的位置\n\n      const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n      const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n      const screenX = event.clientX - offsetLeft + scrollLeft;\n      const screenY = event.clientY - offsetTop + scrollTop;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const nearNode = findNearbyNode({\n        x: (screenX - x) / k,\n        y: (screenY - y) / k\n      }, nodes, LINK_AREA); // 需要找到链接的是哪个节点\n\n      if (nearNode) {\n        const {\n          targetNode,\n          targetPos\n        } = nearNode;\n        const newLink = {\n          id: dragLink.originId + CONNECTOR + targetNode.id + CONNECTOR + targetPos,\n          source: dragLink.originId,\n          target: targetNode.id,\n          sourcePos: this.state.sourcePos,\n          targetPos\n        };\n        setLinks([...links, newLink]);\n      }\n\n      this.setState({\n        isDraggingLink: false,\n        dragLink: null,\n        sourcePos: \"\"\n      });\n    };\n\n    this.handleNodeIsOverGroup = (currentGroup, dragNode) => {\n      const {\n        updateNodes,\n        updateGroups\n      } = this.props;\n\n      if (checkNodeIsOverGroup(dragNode, currentGroup, \"leave\") === \"out\") {\n        // 该节点是否在组外\n        //console.log(\"leave out\", dragNode);\n        updateNodes({ ...dragNode,\n          groupId: \"\"\n        });\n        const newNodes = currentGroup.nodes.filter(node => node.id !== dragNode.id); // 更新组，重新计算组的宽度\n\n        updateGroups(newNodes, dragNode.groupId);\n      } else {\n        //console.log(\"leave in\");\n        // 改变组的大小\n        const newNodes = currentGroup.nodes.map(node => node.id === dragNode.id ? dragNode : node);\n        updateGroups(newNodes);\n      }\n    };\n\n    this.onDragNodeMouseDown = (node, event) => {\n      if (node) {\n        const {\n          k,\n          x,\n          y\n        } = this.props.currTrans;\n        const {\n          offsetTop,\n          offsetLeft\n        } = getOffset(this.container.current);\n        const screenX = event.clientX - offsetLeft;\n        const screenY = event.clientY - offsetTop;\n        this.setState(preState => {\n          // 计算鼠标位置在节点中的偏移量\n          return {\n            isDraggingNode: true,\n            dragNode: node,\n            dragNodeOffset: {\n              x: (screenX - x) / k - node.x,\n              y: (screenY - y) / k - node.y\n            }\n          };\n        });\n      }\n    };\n\n    this.onDragNodeMouseMove = event => {\n      event.preventDefault();\n      event.stopPropagation();\n      const {\n        setNodes,\n        nodes,\n        groups\n      } = this.props;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop; // 判断当前节点平移后是否溢出画布\n      // const isOver = this.checkNodeIsOverScreen(dragNode, screenX, screenY);\n      // if (!isOver) {\n\n      this.setState(preState => {\n        const {\n          dragNode,\n          dragNodeOffset\n        } = preState;\n        const newX = (screenX - x) / k - dragNodeOffset.x;\n        const newY = (screenY - y) / k - dragNodeOffset.y;\n        return { ...preState,\n          dragNode: { ...dragNode,\n            x: newX,\n            y: newY\n          }\n        };\n      });\n      const {\n        dragNodeOffset,\n        dragNode\n      } = this.state;\n      setNodes(nodes.map(c => {\n        return c.id === dragNode.id ? { ...c,\n          x: (screenX - x) / k - dragNodeOffset.x,\n          y: (screenY - y) / k - dragNodeOffset.y\n        } : c;\n      }));\n    };\n\n    this.onDragNodeMouseUp = event => {\n      event.stopPropagation();\n      const {\n        groups,\n        updateNodes,\n        updateGroups\n      } = this.props;\n      const {\n        dragNode\n      } = this.state; // 通过是否有groupId来区分是从组中脱离还是拖入组中\n\n      if (groups) {\n        groups.forEach(group => {\n          const {\n            nodes\n          } = group; // 判断根据拖拽的节点有无groupId来属于enter还是leave\n\n          const groupId = dragNode === null || dragNode === void 0 ? void 0 : dragNode.groupId;\n\n          if (groupId) {\n            // 拖出\n            this.handleNodeIsOverGroup(group, dragNode);\n          } else {\n            // 考虑是否在组内\n            if (checkNodeIsOverGroup(dragNode, group, \"enter\") === \"in\") {\n              const newNodes = [...nodes, dragNode]; // 更新组，重新计算组的宽度\n\n              updateGroups(newNodes);\n            } else {\n              updateGroups(nodes);\n            }\n          }\n        });\n      }\n\n      this.setState({\n        isDraggingNode: false\n      });\n    };\n\n    this.onDragGroupMouseDown = (group, event) => {\n      if (group) {\n        const {\n          k,\n          x,\n          y\n        } = this.props.currTrans;\n        const {\n          offsetTop,\n          offsetLeft\n        } = getOffset(this.container.current);\n        const screenX = event.clientX - offsetLeft;\n        const screenY = event.clientY - offsetTop;\n        this.setState(preState => {\n          // 计算鼠标位置在节点中的偏移量\n          return {\n            isDraggingGroup: true,\n            dragGroup: group,\n            dragGroupOffset: {\n              x: (screenX - x) / k - group.x,\n              y: (screenY - y) / k - group.y\n            }\n          };\n        });\n      }\n    };\n\n    this.onDragGroupMouseMove = event => {\n      event.preventDefault();\n      event.stopPropagation();\n      const {\n        setGroups,\n        groups,\n        nodes,\n        setNodes\n      } = this.props;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      let diffX = 0;\n      let diffY = 0;\n      this.setState(preState => {\n        const {\n          dragGroup,\n          dragGroupOffset\n        } = preState;\n        const newX = (screenX - x) / k - dragGroupOffset.x;\n        const newY = (screenY - y) / k - dragGroupOffset.y;\n        diffX = dragGroup.x - newX;\n        diffY = dragGroup.y - newY;\n        return { ...preState,\n          dragGroup: { ...dragGroup,\n            x: newX,\n            y: newY\n          }\n        };\n      });\n      const {\n        dragGroupOffset,\n        dragGroup\n      } = this.state;\n      const newGroups = groups.map(c => {\n        if (c.id === dragGroup.id) {\n          const nodes = c.nodes;\n          return { ...c,\n            x: (screenX - x) / k - dragGroupOffset.x,\n            y: (screenY - y) / k - dragGroupOffset.y,\n            // 更新节点\n            nodes: nodes.map(node => {\n              return { ...node,\n                x: node.x - diffX,\n                y: node.y - diffY\n              };\n            })\n          };\n        } else {\n          return c;\n        }\n      }); // 同时更新nodes\n\n      const newNodes = nodes.map(node => {\n        if (node.groupId === dragGroup.id) {\n          return { ...node,\n            x: node.x - diffX,\n            y: node.y - diffY\n          };\n        } else {\n          return node;\n        }\n      });\n      setNodes(newNodes);\n      setGroups(newGroups);\n    };\n\n    this.onDragGroupMouseUp = event => {\n      event.stopPropagation();\n      const {\n        groups,\n        updateNodes,\n        updateGroups\n      } = this.props;\n      const {\n        dragGroup\n      } = this.state;\n      this.setState({\n        isDraggingGroup: false,\n        dragGroup: null,\n        dragGroupOffset: null\n      });\n    };\n\n    this.getTransformInfo = currTrans => {\n      console.log(currTrans);\n      this.props.setCurrTrans(currTrans);\n    };\n\n    this.getScreenHandler = handleMap => {\n      this.handleApplyTransform = handleMap.handleApplyTransform;\n      this.handleResize = handleMap.handleResize;\n      this.handleResizeTo = handleMap.handleResizeTo;\n      this.handleAdapt = handleMap.handleAdapt;\n      this.screenWidth = handleMap.screenWidth;\n      this.screenHeight = handleMap.screenHeight;\n    };\n\n    this.handleClearActive = () => {\n      this.props.setSelectedLinks([]);\n      this.props.setSelectedNodes([]);\n    };\n\n    this.hasNodeOrLink = (array, node, link) => {\n      let isNodeOrLink = false;\n\n      for (let i = 0; i < array.length; i++) {\n        const inNode = _.includes(array[i].classList, node);\n\n        const inLink = _.includes(array[i].classList, link);\n\n        if (inNode || inLink) {\n          isNodeOrLink = true;\n          break;\n        }\n      }\n\n      return isNodeOrLink;\n    };\n\n    this.changeScreenScale = screenScale => {\n      this.setState({\n        screenScale\n      });\n    };\n\n    this.handleFullScreen = () => {\n      const fullScreen = isFull();\n\n      if (fullScreen) {\n        exitFullscreen();\n      } else {\n        launchFullscreen(this.container.current);\n      }\n    };\n\n    this.handleShowAll = () => {\n      var _$maxBy, _$maxBy2, _$maxBy3, _$maxBy4;\n\n      const {\n        nodes\n      } = this.props;\n\n      if (nodes && nodes.length === 0) {\n        return;\n      } // 组件实际范围\n\n\n      const minX = _.minBy(nodes, c => c.x).x;\n\n      const maxX = ((_$maxBy = _.maxBy(nodes, c => c.x)) === null || _$maxBy === void 0 ? void 0 : _$maxBy.x) + ((_$maxBy2 = _.maxBy(nodes, c => c.x)) === null || _$maxBy2 === void 0 ? void 0 : _$maxBy2.width);\n\n      const minY = _.minBy(nodes, c => c.y).y;\n\n      const maxY = ((_$maxBy3 = _.maxBy(nodes, c => c.y)) === null || _$maxBy3 === void 0 ? void 0 : _$maxBy3.y) + ((_$maxBy4 = _.maxBy(nodes, c => c.y)) === null || _$maxBy4 === void 0 ? void 0 : _$maxBy4.height);\n      const componentWidth = maxX - minX;\n      const componentHeight = maxY - minY; // 先在不缩放的场景下，平移到画布中点\n\n      const x = this.screenWidth / 2 - (minX + maxX) / 2;\n      const y = this.screenHeight / 2 - (minY + maxY) / 2;\n      const transform = zoomIdentity.translate(x, y).scale(1);\n      console.log(\"transform=\", transform); // 适应画布最大100%，保证在节点少的情况下不发生放大\n\n      const scale = Math.min(this.screenWidth / componentWidth, this.screenHeight / componentHeight, 1); // Todo 待收敛到 ReScreen\n\n      const P0 = [this.screenWidth / 2, this.screenHeight / 2];\n      const P1 = transform.invert(P0);\n      const newTransform = zoomIdentity.translate(P0[0] - P1[0] * scale, P0[1] - P1[1] * scale).scale(scale);\n      this.handleApplyTransform(newTransform);\n    };\n\n    this.layout = () => {\n      var _$maxBy5, _$maxBy6;\n\n      const {\n        nodes,\n        links,\n        setNodes\n      } = this.props;\n\n      if (nodes && nodes.length === 0) {\n        return {\n          nodes,\n          screen: {\n            k: 1,\n            x: 0,\n            y: 0\n          }\n        };\n      }\n\n      const datas = nodes.map(component => {\n        // 兼容 BaseLayout 数据结构\n        component.nodeWidth = component.width;\n        component.nodeHeight = component.height;\n        const downRelations = links.filter(link => {\n          return link.target === component.id;\n        }).map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n        const upRelations = links.filter(link => {\n          return link.source === component.id;\n        }).map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n        return {\n          id: component.id,\n          downRelations,\n          upRelations\n        };\n      });\n      const maxWidth = (_$maxBy5 = _.maxBy(nodes, item => item.width)) === null || _$maxBy5 === void 0 ? void 0 : _$maxBy5.width;\n      const maxHeight = (_$maxBy6 = _.maxBy(nodes, item => item.height)) === null || _$maxBy6 === void 0 ? void 0 : _$maxBy6.height;\n      const dag = new BaseLayout.DAG({\n        isTransverse: true,\n        padding: 20,\n        margin: {\n          left: 0,\n          right: 0,\n          top: 0,\n          bottom: 0\n        },\n        defaultNodeWidth: maxWidth,\n        defaultNodeHeight: maxHeight\n      });\n      const {\n        nodes: newNodes\n      } = dag.getMultiDAG(datas);\n      const layoutNodes = nodes.map(component => {\n        const node = _.find(newNodes, n => n.id === component.id);\n\n        return { ...component,\n          x: node.view.x,\n          y: node.view.y\n        };\n      });\n      setNodes(layoutNodes);\n    };\n\n    this.onSelectLink = key => {\n      const {\n        selectedLinks,\n        setSelectedLinks\n      } = this.props;\n\n      if (selectedLinks) {\n        // 若连线已高线，则取消高亮状态\n        const index = _.findIndex(selectedLinks, link => link === key);\n\n        if (index > -1) {\n          setSelectedLinks([...selectedLinks.slice(0, index), ...selectedLinks.slice(index + 1)]);\n        } else {\n          setSelectedLinks([...selectedLinks, key]);\n        }\n      } else {\n        setSelectedLinks([key]);\n      }\n    };\n\n    this.onClickNode = currentNode => {\n      const {\n        selectedNodes,\n        setSelectedNodes,\n        setSelectedLinks,\n        isKeyPressing\n      } = this.props; // 区分多选按钮是否按下\n\n      if (isKeyPressing) {\n        if (selectedNodes) {\n          // 若节点已被点击则清除点击状态\n          const index = _.findIndex(selectedNodes, id => id === currentNode.id);\n\n          if (index > -1) {\n            setSelectedNodes([...selectedNodes.slice(0, index), ...selectedNodes.slice(index + 1)]);\n          } else {\n            setSelectedNodes(_.compact([...selectedNodes, currentNode.id]));\n          }\n        } else {\n          setSelectedNodes([currentNode.id]);\n        }\n      } else {\n        setSelectedNodes([currentNode.id]); // 清空高亮的连线\n\n        setSelectedLinks(null);\n      }\n    };\n\n    this.onSelectNode = (currentNode, key) => {\n      const {\n        selectedNodes,\n        deleteNodes\n      } = this.props;\n\n      if (key === OperateType.delete) {\n        // 删除组件以及删除连线\n        // 判断改节点是否在多选区域内\n        if (selectedNodes && selectedNodes.includes(currentNode.id)) {\n          deleteNodes(_.compact([...selectedNodes, currentNode.id]));\n        } else {\n          deleteNodes([currentNode.id]);\n        }\n      }\n    };\n\n    this.onContextMenuLink = (key, event) => {\n      event.preventDefault();\n      event.stopPropagation();\n      this.props.setSelectedLinks([key]); // 清空高亮的组件\n\n      this.props.setSelectedNodes(null);\n      const currentPos = {\n        x: event.clientX,\n        y: event.clientY\n      };\n      this.setState({\n        deleteVisible: true,\n        menuPos: currentPos\n      });\n    };\n\n    this.onResize = (node, width, height, x, y) => {\n      const {\n        updateNodes\n      } = this.props;\n      const newNode = { ...node,\n        width,\n        height,\n        x,\n        y\n      };\n      updateNodes(newNode);\n    };\n\n    this.renderCanvas = () => {\n      const {\n        currentHoverNode\n      } = this.state;\n      const {\n        nodes,\n        links,\n        selectedNodes,\n        selectedLinks,\n        groups\n      } = this.props;\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"editor-view\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 901,\n          columnNumber: 7\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"editor-view-content\",\n        ref: this.nodesContainerRef,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 902,\n          columnNumber: 9\n        }\n      }, (nodes || []).map(child => {\n        const id = child === null || child === void 0 ? void 0 : child.id;\n        const isSelected = selectedNodes ? selectedNodes.includes(id) : false;\n        const showSelector = isSelected || currentHoverNode === id;\n        return /*#__PURE__*/React.createElement(EditorNode, {\n          nodeRef: child.ref,\n          currentNode: child,\n          key: id,\n          onClick: this.onClickNode,\n          isSelected: isSelected,\n          showSelector: showSelector,\n          onResize: this.onResize.bind(this, child),\n          currTrans: this.props.currTrans,\n          onSelect: this.onSelectNode,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 910,\n            columnNumber: 15\n          }\n        });\n      }), (groups || []).map(child => {\n        const id = child === null || child === void 0 ? void 0 : child.id;\n        const nodesInGroup = child === null || child === void 0 ? void 0 : child.nodes;\n        return /*#__PURE__*/React.createElement(EditorGroup, {\n          key: id,\n          id: id,\n          groupRef: child === null || child === void 0 ? void 0 : child.ref,\n          currentGroup: child,\n          nodes: nodesInGroup,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 928,\n            columnNumber: 15\n          }\n        });\n      }), /*#__PURE__*/React.createElement(EditorEdges, {\n        links: links,\n        nodes: nodes,\n        selectedLinks: selectedLinks,\n        onContextMenu: this.onContextMenuLink,\n        onSelectLink: this.onSelectLink,\n        isDraggingLink: this.state.isDraggingLink,\n        dragLink: this.state.dragLink,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 938,\n          columnNumber: 11\n        }\n      })));\n    };\n\n    this.state = {\n      isDraggingNode: false,\n      isDraggingLink: false,\n      isDraggingGroup: false,\n      dragNode: null,\n      dragLink: null,\n      dragGroup: null,\n      dragNodeOffset: null,\n      dragGroupOffset: null,\n      menuDisplay: false,\n      menuPos: {\n        id: \"\",\n        x: 0,\n        y: 0\n      },\n      screenScale: 100,\n      sourcePos: \"\",\n      currentHoverNode: \"\",\n      deleteVisible: false\n    };\n    this.nodesContainerRef = React.createRef();\n    this.container = React.createRef();\n  }\n\n  componentDidMount() {\n    this.nodesContainerRef.current.addEventListener(\"mousedown\", this.onNodesContainerMouseDown);\n    this.container.current.addEventListener(\"contextmenu\", this.openContainerMenu);\n    this.container.current.addEventListener(\"click\", this.onContainerMouseDown); // 初始化布局\n\n    this.handleApplyTransform(zoomIdentity);\n  }\n\n  componentWillUnmount() {\n    this.nodesContainerRef.current.removeEventListener(\"mousedown\", this.onNodesContainerMouseDown);\n    this.container.current.removeEventListener(\"contextmenu\", this.openContainerMenu);\n    this.container.current.removeEventListener(\"click\", this.onContainerMouseDown);\n  }\n\n  componentWillUpdate(nextProps, nextState) {\n    if (this.state.isDraggingNode !== nextState.isDraggingNode) {\n      this.toggleDragNode(nextState.isDraggingNode);\n    }\n\n    if (this.state.isDraggingLink !== nextState.isDraggingLink) {\n      this.toggleDragLink(nextState.isDraggingLink);\n    }\n\n    if (this.state.isDraggingGroup !== nextState.isDraggingGroup) {\n      this.toggleDragGroup(nextState.isDraggingGroup);\n    }\n\n    if (nextProps.groups !== this.props.groups) {\n      this.forceUpdate();\n    }\n  }\n  /** 打开全局操作菜单，包括复制，粘贴，删除等 */\n\n\n  onDrag(event, name) {}\n\n  onDrop(event) {\n    const {\n      setNodes,\n      nodes,\n      dragNode\n    } = this.props;\n    const {\n      offsetTop,\n      offsetLeft\n    } = getOffset(this.container.current); // 计算滚动条的位置\n\n    const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n    const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n    const {\n      k,\n      x,\n      y\n    } = this.props.currTrans;\n\n    if (dragNode) {\n      // 新添加了chart属性\n      const {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart\n      } = dragNode;\n      const newNode = {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart,\n        x: (screenX - x) / k - NODE_WIDTH / 2,\n        y: (screenY - y) / k - NODE_HEIGHT / 2,\n        id: uuid.v4(),\n        ref: React.createRef()\n      };\n      setNodes([...nodes, newNode]);\n    }\n  }\n  /** 清空高亮组件和连线 */\n\n\n  render() {\n    const {\n      deleteVisible,\n      menuPos\n    } = this.state;\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"canvas-container-content\",\n      ref: this.container,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 955,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(\"svg\", {\n      className: \"svg-caves\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 956,\n        columnNumber: 9\n      }\n    }), /*#__PURE__*/React.createElement(ReScreen, {\n      type: \"DOM\",\n      getScreenHandler: this.getScreenHandler,\n      needMinimap: true,\n      needRefresh: true,\n      zoomEnabled: false,\n      mapPosition: \"RT-IN\",\n      mapWidth: 200,\n      mapHeight: 300,\n      height: defaultCavasProps.height,\n      width: defaultCavasProps.width,\n      mapRectStyle: {\n        stroke: \"#468CFF\",\n        fill: \"transparent\",\n        strokeWidth: 1.5\n      },\n      focusEnabled: 2,\n      onScreenChange: this.getTransformInfo,\n      onDragOver: event => {\n        event.preventDefault();\n      },\n      onDrop: this.onDrop.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 957,\n        columnNumber: 9\n      }\n    }, this.renderCanvas()), /*#__PURE__*/React.createElement(ContextMenu, {\n      visible: deleteVisible // onHide={() => {\n      //   this.props.setLinks(null);\n      //   this.setState({\n      //     deleteVisible: false\n      //   });\n      // }}\n      ,\n      left: menuPos.x,\n      top: menuPos.y // onClick={this.handleDeleteLinks.bind(this, selectedLinks)}\n      ,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 983,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(Menu, {\n      getPopupContainer: triggerNode => triggerNode.parentNode,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 995,\n        columnNumber: 11\n      }\n    }, [{\n      name: \"删除\",\n      key: OperateType.delete\n    }].map(child => {\n      return /*#__PURE__*/React.createElement(Menu.Item, {\n        key: child.key,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 1004,\n          columnNumber: 22\n        }\n      }, child.name);\n    }))));\n  }\n\n}","map":{"version":3,"sources":["/Users/majy/work/bici/code/editor-demo/src/features/editor/common/CanvasContent.tsx"],"names":["React","_","uuid","ReScreen","BaseLayout","zoomIdentity","Menu","EditorNode","EditorGroup","EditorEdges","ContextMenu","CONNECTOR","OperateType","NODE_WIDTH","NODE_HEIGHT","LINK_AREA","findNearbyNode","calcLinkPosition","checkNodeIsOverGroup","exitFullscreen","launchFullscreen","isFull","getOffset","defaultCavasProps","width","height","CanvasContent","Component","constructor","props","nodesContainerRef","container","screenWidth","screenHeight","handleApplyTransform","handleResize","handleAdapt","handleResizeTo","openContainerMenu","event","preventDefault","toggleDragGroup","isDraggingGroup","window","addEventListener","onDragGroupMouseMove","onDragGroupMouseUp","removeEventListener","toggleDragNode","isDraggingNode","onDragNodeMouseMove","onDragNodeMouseUp","toggleDragLink","isDraggingLink","onDragLinkMouseMove","onDragLinkMouseUp","stopPropagation","offsetTop","offsetLeft","current","scrollLeft","document","documentElement","querySelector","scrollTop","screenX","clientX","screenY","clientY","k","x","y","currTrans","setState","preState","dragLink","onNodesContainerMouseDown","console","log","nodes","groups","length","currentNode","find","c","ref","contains","target","type","dataset","position","onDragLinkMouseDown","onDragNodeMouseDown","currentGroup","onDragGroupMouseDown","onContainerMouseDown","path","isNodeOrLink","hasNodeOrLink","handleClearActive","onNodesContainerMouseMove","currentHoverNode","id","node","originId","originX","originY","sourcePos","setLinks","links","state","nearNode","targetNode","targetPos","newLink","source","handleNodeIsOverGroup","dragNode","updateNodes","updateGroups","groupId","newNodes","filter","map","dragNodeOffset","setNodes","newX","newY","forEach","group","dragGroup","dragGroupOffset","setGroups","diffX","diffY","newGroups","getTransformInfo","setCurrTrans","getScreenHandler","handleMap","setSelectedLinks","setSelectedNodes","array","link","i","inNode","includes","classList","inLink","changeScreenScale","screenScale","handleFullScreen","fullScreen","handleShowAll","minX","minBy","maxX","maxBy","minY","maxY","componentWidth","componentHeight","transform","translate","scale","Math","min","P0","P1","invert","newTransform","layout","screen","datas","component","nodeWidth","nodeHeight","downRelations","sourceId","targetId","upRelations","maxWidth","item","maxHeight","dag","DAG","isTransverse","padding","margin","left","right","top","bottom","defaultNodeWidth","defaultNodeHeight","getMultiDAG","layoutNodes","n","view","onSelectLink","key","selectedLinks","index","findIndex","slice","onClickNode","selectedNodes","isKeyPressing","compact","onSelectNode","deleteNodes","delete","onContextMenuLink","currentPos","deleteVisible","menuPos","onResize","newNode","renderCanvas","child","isSelected","showSelector","bind","nodesInGroup","menuDisplay","createRef","componentDidMount","componentWillUnmount","componentWillUpdate","nextProps","nextState","forceUpdate","onDrag","name","onDrop","chart","v4","render","stroke","fill","strokeWidth","triggerNode","parentNode"],"mappings":"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","sourcesContent":["/**\n * @file 处理画布内的操作\n */\n\nimport * as React from \"react\";\nimport * as _ from \"lodash\";\nimport * as uuid from \"uuid\";\nimport { ReScreen, BaseLayout } from \"regraph-next\";\nimport { ZoomTransform, zoomIdentity } from \"d3-zoom\";\nimport { Menu } from \"antd\";\nimport { EditorNode } from \"./EditorNode\";\nimport { EditorGroup } from \"./EditorGroup\";\nimport { EditorEdges } from \"./EditorEdges\";\nimport { ContextMenu } from \"./ContextMenu\";\nimport {\n  MenuPos,\n  CONNECTOR,\n  OperateType,\n  Link,\n  Node,\n  Group,\n  NODE_WIDTH,\n  NODE_HEIGHT,\n  LINK_AREA\n} from \"../constants/defines\";\nimport {\n  findUpstreamNode,\n  findAllUpstreamNodes,\n  findDownstreamNode,\n  findAllDownstreamNodes,\n  findAllDownstreamLinks,\n  findNearbyNode\n} from \"../utils/find\";\nimport { calcLinkPosition } from \"../utils/calc\";\nimport { pointInPoly, checkNodeIsOverGroup } from \"../utils/layout\";\nimport { exitFullscreen, launchFullscreen, isFull, getOffset } from \"./utils\";\nimport { CanvasContentProps, CanvasContentState } from '../constants/cavasTypes'\n\nconst defaultCavasProps={\n  width: 1366,\n  height:768\n}\n\nexport default class CanvasContent extends React.Component<\n  CanvasContentProps,\n  CanvasContentState\n> {\n  nodesContainerRef: any;\n  container: any;\n  screenWidth: number;\n  screenHeight: number;\n\n  handleApplyTransform: (transform: ZoomTransform) => void;\n  handleResize: (isLarge: boolean) => void;\n  handleAdapt: () => void;\n  handleResizeTo: (scale: number, P0?: [number, number]) => void;\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      isDraggingNode: false,\n      isDraggingLink: false,\n      isDraggingGroup: false,\n      dragNode: null,\n      dragLink: null,\n      dragGroup: null,\n      dragNodeOffset: null,\n      dragGroupOffset: null,\n      menuDisplay: false,\n      menuPos: {\n        id: \"\",\n        x: 0,\n        y: 0\n      },\n      screenScale: 100,\n      sourcePos: \"\",\n      currentHoverNode: \"\",\n      deleteVisible: false\n    };\n    this.nodesContainerRef = React.createRef();\n    this.container = React.createRef();\n  }\n\n  componentDidMount() {\n    this.nodesContainerRef.current.addEventListener(\n      \"mousedown\",\n      this.onNodesContainerMouseDown\n    );\n    this.container.current.addEventListener(\n      \"contextmenu\",\n      this.openContainerMenu\n    );\n    this.container.current.addEventListener(\"click\", this.onContainerMouseDown);\n\n    // 初始化布局\n    this.handleApplyTransform(zoomIdentity);\n  }\n\n  componentWillUnmount() {\n    this.nodesContainerRef.current.removeEventListener(\n      \"mousedown\",\n      this.onNodesContainerMouseDown\n    );\n    this.container.current.removeEventListener(\n      \"contextmenu\",\n      this.openContainerMenu\n    );\n    this.container.current.removeEventListener(\n      \"click\",\n      this.onContainerMouseDown\n    );\n  }\n\n  componentWillUpdate(\n    nextProps: CanvasContentProps,\n    nextState: CanvasContentState\n  ) {\n    if (this.state.isDraggingNode !== nextState.isDraggingNode) {\n      this.toggleDragNode(nextState.isDraggingNode);\n    }\n    if (this.state.isDraggingLink !== nextState.isDraggingLink) {\n      this.toggleDragLink(nextState.isDraggingLink);\n    }\n    if (this.state.isDraggingGroup !== nextState.isDraggingGroup) {\n      this.toggleDragGroup(nextState.isDraggingGroup);\n    }\n    if (nextProps.groups !== this.props.groups) {\n      this.forceUpdate();\n    }\n  }\n\n  /** 打开全局操作菜单，包括复制，粘贴，删除等 */\n  openContainerMenu = (event: any) => {\n    event.preventDefault();\n  };\n\n  toggleDragGroup = (isDraggingGroup: Boolean) => {\n    if (isDraggingGroup) {\n      window.addEventListener(\"mousemove\", this.onDragGroupMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragGroupMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragGroupMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragGroupMouseUp);\n    }\n  };\n\n  toggleDragNode = (isDraggingNode: Boolean) => {\n    if (isDraggingNode) {\n      window.addEventListener(\"mousemove\", this.onDragNodeMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragNodeMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragNodeMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragNodeMouseUp);\n    }\n  };\n\n  toggleDragLink = (isDraggingLink: Boolean) => {\n    if (isDraggingLink) {\n      window.addEventListener(\"mousemove\", this.onDragLinkMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragLinkMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragLinkMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragLinkMouseUp);\n    }\n  };\n\n  onDragLinkMouseMove = (event: any) => {\n    event.stopPropagation();\n    event.preventDefault();\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    this.setState(preState => {\n      const { dragLink } = preState;\n      return {\n        dragLink: {\n          ...dragLink,\n          x: (screenX - x) / k,\n          y: (screenY - y) / k\n        }\n      };\n    });\n  };\n\n  /** 监听整个区域，提升性能 */\n  onNodesContainerMouseDown = (event: any) => {\n    console.log(\"onNodesContainerMouseDown\");\n    event.stopPropagation();\n    const { nodes, groups } = this.props;\n    // 如果画布中有节点\n    if (nodes && nodes.length > 0) {\n      const currentNode = _.find(nodes, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      });\n\n      const type = event.target.dataset && event.target.dataset.type;\n      const position = event.target.dataset && event.target.dataset.position;\n      // 如果当前选中的是节点\n      console.log(\"currentNode==\",currentNode)\n      if (currentNode) {\n        if (type === \"edge\" && position) {\n          /** 拖拽连线 */\n          this.onDragLinkMouseDown(currentNode as any, position);\n          return;\n        } else if (type === \"resize\") {\n          return;\n        } else {\n          /** 拖拽节点，排除resize节点 */\n          this.onDragNodeMouseDown(currentNode as any, event);\n        }\n      }\n    }\n\n    if (groups && groups.length > 0) {\n      const currentGroup = _.find(groups, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      });\n      this.onDragGroupMouseDown(currentGroup as any, event);\n    }\n  };\n\n  /** 监听整个容器click事件 */\n  onContainerMouseDown = (event: any) => {\n    // event.stopPropagation();\n\n    // 过滤掉节点和边\n    const path = event.path;\n    const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n    if (!isNodeOrLink) {\n      // 清空高亮的节点和边\n      this.handleClearActive();\n    }\n  };\n\n  /** 监听整个容器mousemove 事件 */\n  onNodesContainerMouseMove = (event: any) => {\n    event.preventDefault();\n    const path = event.path;\n    const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n    const { nodes } = this.props;\n\n    if (nodes && nodes.length > 0) {\n      const currentNode = _.find(nodes, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      }) as Node;\n\n      if (currentNode) {\n        if (isNodeOrLink) {\n          this.setState({\n            currentHoverNode: currentNode.id\n          });\n        } else {\n          this.setState({\n            currentHoverNode: \"\"\n          });\n        }\n      }\n    }\n  };\n\n  /** 鼠标按下，进行连线 */\n  onDragLinkMouseDown = (node: Node, position: string) => {\n    const { x, y } = calcLinkPosition(node, position);\n    this.setState({\n      isDraggingLink: true,\n      dragLink: {\n        originId: node.id,\n        originX: x,\n        originY: y,\n        x,\n        y\n      },\n      sourcePos: position\n    });\n  };\n\n  /** 鼠标抬起，连线结束 */\n  onDragLinkMouseUp = (event: any) => {\n    const { setLinks, links, nodes } = this.props;\n    const { dragLink } = this.state;\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const nearNode = findNearbyNode(\n      {\n        x: (screenX - x) / k,\n        y: (screenY - y) / k\n      },\n      nodes,\n      LINK_AREA\n    );\n\n    // 需要找到链接的是哪个节点\n\n    if (nearNode) {\n      const { targetNode, targetPos } = nearNode;\n      const newLink = {\n        id:\n          dragLink.originId + CONNECTOR + targetNode.id + CONNECTOR + targetPos,\n        source: dragLink.originId,\n        target: targetNode.id,\n        sourcePos: this.state.sourcePos,\n        targetPos\n      };\n      setLinks([...links, newLink]);\n    }\n\n    this.setState({\n      isDraggingLink: false,\n      dragLink: null,\n      sourcePos: \"\"\n    });\n  };\n\n  /** 处理节点与组的关系 */\n  handleNodeIsOverGroup = (currentGroup: Group, dragNode: Node) => {\n    const { updateNodes, updateGroups } = this.props;\n\n    if (checkNodeIsOverGroup(dragNode, currentGroup, \"leave\") === \"out\") {\n      // 该节点是否在组外\n      //console.log(\"leave out\", dragNode);\n      updateNodes({ ...dragNode, groupId: \"\" });\n      const newNodes = currentGroup.nodes.filter(\n        node => node.id !== dragNode.id\n      );\n      // 更新组，重新计算组的宽度\n      updateGroups(newNodes, dragNode.groupId);\n    } else {\n      //console.log(\"leave in\");\n      // 改变组的大小\n      const newNodes = currentGroup.nodes.map(node =>\n        node.id === dragNode.id ? dragNode : node\n      );\n      updateGroups(newNodes);\n    }\n  };\n\n  /** 按下节点 */\n  onDragNodeMouseDown = (node: Node, event: any) => {\n    if (node) {\n      const { k, x, y } = this.props.currTrans;\n\n      const { offsetTop, offsetLeft } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      this.setState(preState => {\n        // 计算鼠标位置在节点中的偏移量\n        return {\n          isDraggingNode: true,\n          dragNode: node,\n          dragNodeOffset: {\n            x: (screenX - x) / k - node.x,\n            y: (screenY - y) / k - node.y\n          }\n        };\n      });\n    }\n  };\n\n  /** 移动节点 */\n  onDragNodeMouseMove = (event: any) => {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const { setNodes, nodes, groups } = this.props;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    const screenX = event.clientX - offsetLeft;\n    const screenY = event.clientY - offsetTop;\n\n    // 判断当前节点平移后是否溢出画布\n    // const isOver = this.checkNodeIsOverScreen(dragNode, screenX, screenY);\n\n    // if (!isOver) {\n    this.setState(preState => {\n      const { dragNode, dragNodeOffset } = preState;\n\n      const newX = (screenX - x) / k - dragNodeOffset.x;\n      const newY = (screenY - y) / k - dragNodeOffset.y;\n\n      return {\n        ...preState,\n        dragNode: {\n          ...dragNode,\n          x: newX,\n          y: newY\n        }\n      };\n    });\n\n    const { dragNodeOffset, dragNode } = this.state;\n\n    setNodes(\n      nodes.map(c => {\n        return c.id === dragNode.id\n          ? {\n              ...c,\n              x: (screenX - x) / k - dragNodeOffset.x,\n              y: (screenY - y) / k - dragNodeOffset.y\n            }\n          : c;\n      })\n    );\n  };\n\n  /** 放开节点 */\n  onDragNodeMouseUp = (event: any) => {\n    event.stopPropagation();\n    const { groups, updateNodes, updateGroups } = this.props;\n\n    const { dragNode } = this.state;\n    // 通过是否有groupId来区分是从组中脱离还是拖入组中\n    if (groups) {\n      groups.forEach(group => {\n        const { nodes } = group;\n\n        // 判断根据拖拽的节点有无groupId来属于enter还是leave\n        const groupId = dragNode?.groupId;\n        if (groupId) {\n          // 拖出\n          this.handleNodeIsOverGroup(group, dragNode);\n        } else {\n          // 考虑是否在组内\n          if (checkNodeIsOverGroup(dragNode, group, \"enter\") === \"in\") {\n            const newNodes = [...nodes, dragNode];\n            // 更新组，重新计算组的宽度\n            updateGroups(newNodes);\n          } else {\n            updateGroups(nodes);\n          }\n        }\n      });\n    }\n\n    this.setState({\n      isDraggingNode: false\n    });\n  };\n\n  /** 按下组 */\n  onDragGroupMouseDown = (group: Group, event: any) => {\n    if (group) {\n      const { k, x, y } = this.props.currTrans;\n\n      const { offsetTop, offsetLeft } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      this.setState(preState => {\n        // 计算鼠标位置在节点中的偏移量\n        return {\n          isDraggingGroup: true,\n          dragGroup: group,\n          dragGroupOffset: {\n            x: (screenX - x) / k - group.x,\n            y: (screenY - y) / k - group.y\n          }\n        };\n      });\n    }\n  };\n\n  /** 移动组 */\n  onDragGroupMouseMove = (event: any) => {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const { setGroups, groups, nodes, setNodes } = this.props;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    const screenX = event.clientX - offsetLeft;\n    const screenY = event.clientY - offsetTop;\n    let diffX = 0;\n    let diffY = 0;\n\n    this.setState(preState => {\n      const { dragGroup, dragGroupOffset } = preState;\n\n      const newX = (screenX - x) / k - dragGroupOffset.x;\n      const newY = (screenY - y) / k - dragGroupOffset.y;\n\n      diffX = dragGroup.x - newX;\n      diffY = dragGroup.y - newY;\n\n      return {\n        ...preState,\n        dragGroup: {\n          ...dragGroup,\n          x: newX,\n          y: newY\n        }\n      };\n    });\n\n    const { dragGroupOffset, dragGroup } = this.state;\n\n    const newGroups = groups.map(c => {\n      if (c.id === dragGroup.id) {\n        const nodes = c.nodes;\n        return {\n          ...c,\n          x: (screenX - x) / k - dragGroupOffset.x,\n          y: (screenY - y) / k - dragGroupOffset.y,\n          // 更新节点\n          nodes: nodes.map(node => {\n            return {\n              ...node,\n              x: node.x - diffX,\n              y: node.y - diffY\n            };\n          })\n        };\n      } else {\n        return c;\n      }\n    });\n    // 同时更新nodes\n\n    const newNodes = nodes.map(node => {\n      if (node.groupId === dragGroup.id) {\n        return {\n          ...node,\n          x: node.x - diffX,\n          y: node.y - diffY\n        };\n      } else {\n        return node;\n      }\n    });\n    setNodes(newNodes);\n    setGroups(newGroups);\n  };\n\n  /** 放开组 */\n  onDragGroupMouseUp = (event: any) => {\n    event.stopPropagation();\n    const { groups, updateNodes, updateGroups } = this.props;\n\n    const { dragGroup } = this.state;\n\n    this.setState({\n      isDraggingGroup: false,\n      dragGroup: null,\n      dragGroupOffset: null\n    });\n  };\n\n  getTransformInfo = (currTrans: ZoomTransform) => {\n    console.log(currTrans)\n    this.props.setCurrTrans(currTrans);\n  };\n\n  getScreenHandler = handleMap => {\n    this.handleApplyTransform = handleMap.handleApplyTransform;\n    this.handleResize = handleMap.handleResize;\n    this.handleResizeTo = handleMap.handleResizeTo;\n    this.handleAdapt = handleMap.handleAdapt;\n    this.screenWidth = handleMap.screenWidth;\n    this.screenHeight = handleMap.screenHeight;\n  };\n\n  onDrag(event, name: string) {}\n\n  onDrop(event: React.DragEvent<HTMLDivElement>) {\n    const { setNodes, nodes, dragNode } = this.props;\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    if (dragNode) {\n      // 新添加了chart属性\n      const { key, name, type, width, height,chart } = dragNode;\n\n      const newNode = {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart,\n        x: (screenX - x) / k - NODE_WIDTH / 2,\n        y: (screenY - y) / k - NODE_HEIGHT / 2,\n        id: uuid.v4(),\n        ref: React.createRef()\n      };\n\n      setNodes([...nodes, newNode]);\n    }\n  }\n\n  /** 清空高亮组件和连线 */\n  handleClearActive = () => {\n    this.props.setSelectedLinks([]);\n    this.props.setSelectedNodes([]);\n  };\n\n  /** 判断点击的节点是否为节点和边 */\n  hasNodeOrLink = (array: any[], node?: string, link?: string) => {\n    let isNodeOrLink = false;\n\n    for (let i = 0; i < array.length; i++) {\n      const inNode = _.includes(array[i].classList, node);\n      const inLink = _.includes(array[i].classList, link);\n\n      if (inNode || inLink) {\n        isNodeOrLink = true;\n        break;\n      }\n    }\n    return isNodeOrLink;\n  };\n\n  /** 改变缩放倍率 */\n  changeScreenScale = (screenScale: number) => {\n    this.setState({\n      screenScale\n    });\n  };\n\n  /** 处理全屏事件 */\n  handleFullScreen = () => {\n    const fullScreen = isFull();\n    if (fullScreen) {\n      exitFullscreen();\n    } else {\n      launchFullscreen(this.container.current);\n    }\n  };\n\n  /** 适应画布 */\n  handleShowAll = () => {\n    const { nodes } = this.props;\n\n    if (nodes && nodes.length === 0) {\n      return;\n    }\n\n    // 组件实际范围\n    const minX = _.minBy(nodes, c => c.x).x;\n    const maxX = _.maxBy(nodes, c => c.x)?.x + _.maxBy(nodes, c => c.x)?.width;\n    const minY = _.minBy(nodes, c => c.y).y;\n    const maxY = _.maxBy(nodes, c => c.y)?.y + _.maxBy(nodes, c => c.y)?.height;\n\n    const componentWidth = maxX - minX;\n    const componentHeight = maxY - minY;\n\n    // 先在不缩放的场景下，平移到画布中点\n    const x = this.screenWidth / 2 - (minX + maxX) / 2;\n    const y = this.screenHeight / 2 - (minY + maxY) / 2;\n    const transform = zoomIdentity.translate(x, y).scale(1);\n    console.log(\"transform=\",transform)\n    // 适应画布最大100%，保证在节点少的情况下不发生放大\n    const scale = Math.min(\n      this.screenWidth / componentWidth,\n      this.screenHeight / componentHeight,\n      1\n    );\n    // Todo 待收敛到 ReScreen\n    const P0 = [this.screenWidth / 2, this.screenHeight / 2] as [\n      number,\n      number\n    ];\n    const P1 = transform.invert(P0);\n    const newTransform = zoomIdentity\n      .translate(P0[0] - P1[0] * scale, P0[1] - P1[1] * scale)\n      .scale(scale);\n    this.handleApplyTransform(newTransform);\n  };\n\n  /** 格式化画布 */\n  layout = () => {\n    const { nodes, links, setNodes } = this.props;\n    if (nodes && nodes.length === 0) {\n      return {\n        nodes,\n        screen: {\n          k: 1,\n          x: 0,\n          y: 0\n        }\n      };\n    }\n\n    const datas = nodes.map(component => {\n      // 兼容 BaseLayout 数据结构\n      (component as any).nodeWidth = component.width;\n      (component as any).nodeHeight = component.height;\n      const downRelations = links\n        .filter(link => {\n          return link.target === component.id;\n        })\n        .map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n      const upRelations = links\n        .filter(link => {\n          return link.source === component.id;\n        })\n        .map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n      return {\n        id: component.id,\n        downRelations,\n        upRelations\n      };\n    });\n\n    const maxWidth = _.maxBy(nodes, item => item.width)?.width;\n    const maxHeight = _.maxBy(nodes, item => item.height)?.height;\n\n    const dag = new BaseLayout.DAG({\n      isTransverse: true,\n      padding: 20,\n      margin: {\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0\n      },\n      defaultNodeWidth: maxWidth,\n      defaultNodeHeight: maxHeight\n    });\n\n    const { nodes: newNodes } = dag.getMultiDAG(datas);\n\n    const layoutNodes = nodes.map(component => {\n      const node = _.find(newNodes, n => n.id === component.id);\n\n      return {\n        ...component,\n        x: node.view.x,\n        y: node.view.y\n      };\n    });\n    setNodes(layoutNodes);\n  };\n\n  /** 点击连线 */\n  onSelectLink = (key: string) => {\n    const { selectedLinks, setSelectedLinks } = this.props;\n    if (selectedLinks) {\n      // 若连线已高线，则取消高亮状态\n      const index = _.findIndex(selectedLinks, link => link === key);\n      if (index > -1) {\n        setSelectedLinks([\n          ...selectedLinks.slice(0, index),\n          ...selectedLinks.slice(index + 1)\n        ]);\n      } else {\n        setSelectedLinks([...selectedLinks, key]);\n      }\n    } else {\n      setSelectedLinks([key]);\n    }\n  };\n\n  /** 点击节点 */\n  onClickNode = (currentNode: Node) => {\n    const {\n      selectedNodes,\n      setSelectedNodes,\n      setSelectedLinks,\n      isKeyPressing\n    } = this.props;\n\n    // 区分多选按钮是否按下\n    if (isKeyPressing) {\n      if (selectedNodes) {\n        // 若节点已被点击则清除点击状态\n        const index = _.findIndex(selectedNodes, id => id === currentNode.id);\n\n        if (index > -1) {\n          setSelectedNodes([\n            ...selectedNodes.slice(0, index),\n            ...selectedNodes.slice(index + 1)\n          ]);\n        } else {\n          setSelectedNodes(_.compact([...selectedNodes, currentNode.id]));\n        }\n      } else {\n        setSelectedNodes([currentNode.id]);\n      }\n    } else {\n      setSelectedNodes([currentNode.id]);\n      // 清空高亮的连线\n      setSelectedLinks(null);\n    }\n  };\n\n  /** 被连线的节点 */\n  onSelectNode = (currentNode: Node, key: OperateType) => {\n    const { selectedNodes, deleteNodes } = this.props;\n    if (key === OperateType.delete) {\n      // 删除组件以及删除连线\n      // 判断改节点是否在多选区域内\n      if (selectedNodes && selectedNodes.includes(currentNode.id)) {\n        deleteNodes(_.compact([...selectedNodes, currentNode.id]));\n      } else {\n        deleteNodes([currentNode.id]);\n      }\n    }\n  };\n\n  /** 右键连线 */\n  onContextMenuLink = (\n    key: string,\n    event: React.MouseEvent<SVGPathElement, MouseEvent>\n  ) => {\n    event.preventDefault();\n    event.stopPropagation();\n    this.props.setSelectedLinks([key]);\n    // 清空高亮的组件\n    this.props.setSelectedNodes(null);\n\n    const currentPos = {\n      x: event.clientX,\n      y: event.clientY\n    };\n    this.setState({\n      deleteVisible: true,\n      menuPos: currentPos\n    });\n  };\n\n  /** 伸缩节点 */\n  onResize = (\n    node: Node,\n    width: number,\n    height: number,\n    x: number,\n    y: number\n  ) => {\n    const { updateNodes } = this.props;\n    const newNode = {\n      ...node,\n      width,\n      height,\n      x,\n      y\n    };\n    updateNodes(newNode);\n  };\n  // 渲染节点内容\n  renderCanvas = () => {\n    const { currentHoverNode } = this.state;\n    const { nodes, links, selectedNodes, selectedLinks, groups } = this.props;\n    return (\n      <div className=\"editor-view\">\n        <div className=\"editor-view-content\" ref={this.nodesContainerRef}>\n          {(nodes || []).map(child => {\n            const id = child?.id;\n            const isSelected = selectedNodes\n              ? selectedNodes.includes(id)\n              : false;\n            const showSelector = isSelected || currentHoverNode === id;\n            return (\n              <EditorNode\n                nodeRef={child.ref}\n                currentNode={child}\n                key={id}\n                onClick={this.onClickNode}\n                isSelected={isSelected}\n                showSelector={showSelector}\n                onResize={this.onResize.bind(this, child)}\n                currTrans={this.props.currTrans}\n                onSelect={this.onSelectNode}\n              />\n            );\n          })}\n\n          {(groups || []).map(child => {\n            const id = child?.id;\n            const nodesInGroup = child?.nodes;\n            return (\n              <EditorGroup\n                key={id}\n                id={id}\n                groupRef={child?.ref}\n                currentGroup={child}\n                nodes={nodesInGroup}\n              />\n            );\n          })}\n\n          <EditorEdges\n            links={links}\n            nodes={nodes}\n            selectedLinks={selectedLinks}\n            onContextMenu={this.onContextMenuLink}\n            onSelectLink={this.onSelectLink}\n            isDraggingLink={this.state.isDraggingLink}\n            dragLink={this.state.dragLink}\n          />\n        </div>\n      </div>\n    );\n  };\n\n  render() {\n    const { deleteVisible, menuPos } = this.state;\n    return (\n      <div className=\"canvas-container-content\" ref={this.container}>\n        <svg className=\"svg-caves\"></svg>\n        <ReScreen\n          type=\"DOM\"\n          getScreenHandler={this.getScreenHandler}\n          needMinimap={true}\n          needRefresh={true}\n          zoomEnabled={false}\n          mapPosition=\"RT-IN\"\n          mapWidth={200}\n          mapHeight={300}\n          height={defaultCavasProps.height}\n          width={defaultCavasProps.width}\n          mapRectStyle={{\n            stroke: \"#468CFF\",\n            fill: \"transparent\",\n            strokeWidth: 1.5\n          }}\n          focusEnabled={2}\n          onScreenChange={this.getTransformInfo}\n          onDragOver={event => {\n            event.preventDefault();\n          }}\n          onDrop={this.onDrop.bind(this)}\n        >\n          {this.renderCanvas()}\n        </ReScreen>\n        {/** 删除连线的菜单 */}\n        <ContextMenu\n          visible={deleteVisible}\n          // onHide={() => {\n          //   this.props.setLinks(null);\n          //   this.setState({\n          //     deleteVisible: false\n          //   });\n          // }}\n          left={menuPos.x}\n          top={menuPos.y}\n          // onClick={this.handleDeleteLinks.bind(this, selectedLinks)}\n        >\n          <Menu\n            getPopupContainer={(triggerNode: any) => triggerNode.parentNode}\n          >\n            {[\n              {\n                name: \"删除\",\n                key: OperateType.delete\n              }\n            ].map(child => {\n              return <Menu.Item key={child.key}>{child.name}</Menu.Item>;\n            })}\n          </Menu>\n        </ContextMenu>\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}