{"ast":null,"code":"var _jsxFileName = \"/Users/majy/work/bici/code/editor-demo/src/features/editor/common/CanvasContent.tsx\";\n\n/**\n * @file 处理画布内的操作\n */\nimport * as React from \"react\";\nimport * as _ from \"lodash\";\nimport * as uuid from \"uuid\";\nimport { ReScreen, BaseLayout } from \"regraph-next\";\nimport { zoomIdentity } from \"d3-zoom\";\nimport { Menu } from \"antd\";\nimport { EditorNode } from \"./EditorNode\";\nimport { EditorGroup } from \"./EditorGroup\";\nimport { EditorEdges } from \"./EditorEdges\";\nimport { ContextMenu } from \"./ContextMenu\";\nimport { CONNECTOR, OperateType, NODE_WIDTH, NODE_HEIGHT, LINK_AREA } from \"../constants/defines\";\nimport { findNearbyNode } from \"../utils/find\";\nimport { calcLinkPosition } from \"../utils/calc\";\nimport { checkNodeIsOverGroup } from \"../utils/layout\";\nimport { exitFullscreen, launchFullscreen, isFull, getOffset } from \"./utils\";\n\nclass CanvasContentProps {\n  constructor() {\n    this.ref = void 0;\n    this.nodes = void 0;\n    this.links = void 0;\n    this.groups = void 0;\n    this.setNodes = void 0;\n    this.setLinks = void 0;\n    this.setGroups = void 0;\n    this.selectedLinks = void 0;\n    this.setSelectedLinks = void 0;\n    this.selectedNodes = void 0;\n    this.setSelectedNodes = void 0;\n    this.dragNode = void 0;\n    this.updateNodes = void 0;\n    this.updateLinks = void 0;\n    this.updateGroups = void 0;\n    this.deleteNodes = void 0;\n    this.deleteLinks = void 0;\n    this.copiedNodes = void 0;\n    this.setCopiedNodes = void 0;\n    this.currTrans = void 0;\n    this.setCurrTrans = void 0;\n    this.isKeyPressing = void 0;\n  }\n\n}\n\nclass CanvasContentState {\n  constructor() {\n    this.isDraggingNode = void 0;\n    this.isDraggingLink = void 0;\n    this.isDraggingGroup = void 0;\n    this.dragGroup = void 0;\n    this.dragNode = void 0;\n    this.dragNodeOffset = void 0;\n    this.dragGroupOffset = void 0;\n    this.dragLink = void 0;\n    this.sourcePos = void 0;\n    this.menuDisplay = void 0;\n    this.menuPos = void 0;\n    this.screenScale = void 0;\n    this.currentHoverNode = void 0;\n    this.deleteVisible = void 0;\n  }\n\n}\n\nexport default class CanvasContent extends React.Component {\n  constructor(props) {\n    super(props);\n    this.nodesContainerRef = void 0;\n    this.container = void 0;\n    this.screenWidth = void 0;\n    this.screenHeight = void 0;\n    this.handleApplyTransform = void 0;\n    this.handleResize = void 0;\n    this.handleAdapt = void 0;\n    this.handleResizeTo = void 0;\n\n    this.openContainerMenu = event => {\n      event.preventDefault();\n    };\n\n    this.toggleDragGroup = isDraggingGroup => {\n      if (isDraggingGroup) {\n        window.addEventListener(\"mousemove\", this.onDragGroupMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragGroupMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragGroupMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragGroupMouseUp);\n      }\n    };\n\n    this.toggleDragNode = isDraggingNode => {\n      if (isDraggingNode) {\n        window.addEventListener(\"mousemove\", this.onDragNodeMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragNodeMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragNodeMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragNodeMouseUp);\n      }\n    };\n\n    this.toggleDragLink = isDraggingLink => {\n      if (isDraggingLink) {\n        window.addEventListener(\"mousemove\", this.onDragLinkMouseMove);\n        window.addEventListener(\"mouseup\", this.onDragLinkMouseUp);\n      } else {\n        window.removeEventListener(\"mousemove\", this.onDragLinkMouseMove);\n        window.removeEventListener(\"mouseup\", this.onDragLinkMouseUp);\n      }\n    };\n\n    this.onDragLinkMouseMove = event => {\n      event.stopPropagation();\n      event.preventDefault();\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current); // 计算滚动条的位置\n\n      const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n      const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n      const screenX = event.clientX - offsetLeft + scrollLeft;\n      const screenY = event.clientY - offsetTop + scrollTop;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      this.setState(preState => {\n        const {\n          dragLink\n        } = preState;\n        return {\n          dragLink: { ...dragLink,\n            x: (screenX - x) / k,\n            y: (screenY - y) / k\n          }\n        };\n      });\n    };\n\n    this.onNodesContainerMouseDown = event => {\n      event.stopPropagation();\n      const {\n        nodes,\n        groups\n      } = this.props;\n\n      if (nodes && nodes.length > 0) {\n        const currentNode = _.find(nodes, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        const type = event.target.dataset && event.target.dataset.type;\n        const position = event.target.dataset && event.target.dataset.position;\n\n        if (currentNode) {\n          if (type === \"edge\" && position) {\n            /** 拖拽连线 */\n            this.onDragLinkMouseDown(currentNode, position);\n            return;\n          } else if (type === \"resize\") {\n            return;\n          } else {\n            /** 拖拽节点，排除resize节点 */\n            this.onDragNodeMouseDown(currentNode, event);\n          }\n        }\n      }\n\n      if (groups && groups.length > 0) {\n        const currentGroup = _.find(groups, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        this.onDragGroupMouseDown(currentGroup, event);\n      }\n    };\n\n    this.onContainerMouseDown = event => {\n      // event.stopPropagation();\n      // 过滤掉节点和边\n      const path = event.path;\n      const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n\n      if (!isNodeOrLink) {\n        // 清空高亮的节点和边\n        this.handleClearActive();\n      }\n    };\n\n    this.onNodesContainerMouseMove = event => {\n      event.preventDefault();\n      const path = event.path;\n      const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n      const {\n        nodes\n      } = this.props;\n\n      if (nodes && nodes.length > 0) {\n        const currentNode = _.find(nodes, c => {\n          if (c.ref && c.ref.current) {\n            return c.ref.current.contains(event.target);\n          }\n\n          return false;\n        });\n\n        if (currentNode) {\n          if (isNodeOrLink) {\n            this.setState({\n              currentHoverNode: currentNode.id\n            });\n          } else {\n            this.setState({\n              currentHoverNode: \"\"\n            });\n          }\n        }\n      }\n    };\n\n    this.onDragLinkMouseDown = (node, position) => {\n      const {\n        x,\n        y\n      } = calcLinkPosition(node, position);\n      this.setState({\n        isDraggingLink: true,\n        dragLink: {\n          originId: node.id,\n          originX: x,\n          originY: y,\n          x,\n          y\n        },\n        sourcePos: position\n      });\n    };\n\n    this.onDragLinkMouseUp = event => {\n      const {\n        setLinks,\n        links,\n        nodes\n      } = this.props;\n      const {\n        dragLink\n      } = this.state;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current); // 计算滚动条的位置\n\n      const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n      const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n      const screenX = event.clientX - offsetLeft + scrollLeft;\n      const screenY = event.clientY - offsetTop + scrollTop;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const nearNode = findNearbyNode({\n        x: (screenX - x) / k,\n        y: (screenY - y) / k\n      }, nodes, LINK_AREA); // 需要找到链接的是哪个节点\n\n      if (nearNode) {\n        const {\n          targetNode,\n          targetPos\n        } = nearNode;\n        const newLink = {\n          id: dragLink.originId + CONNECTOR + targetNode.id + CONNECTOR + targetPos,\n          source: dragLink.originId,\n          target: targetNode.id,\n          sourcePos: this.state.sourcePos,\n          targetPos\n        };\n        setLinks([...links, newLink]);\n      }\n\n      this.setState({\n        isDraggingLink: false,\n        dragLink: null,\n        sourcePos: \"\"\n      });\n    };\n\n    this.handleNodeIsOverGroup = (currentGroup, dragNode) => {\n      const {\n        updateNodes,\n        updateGroups\n      } = this.props;\n\n      if (checkNodeIsOverGroup(dragNode, currentGroup, \"leave\") === \"out\") {\n        // 该节点是否在组外\n        //console.log(\"leave out\", dragNode);\n        updateNodes({ ...dragNode,\n          groupId: \"\"\n        });\n        const newNodes = currentGroup.nodes.filter(node => node.id !== dragNode.id); // 更新组，重新计算组的宽度\n\n        updateGroups(newNodes, dragNode.groupId);\n      } else {\n        //console.log(\"leave in\");\n        // 改变组的大小\n        const newNodes = currentGroup.nodes.map(node => node.id === dragNode.id ? dragNode : node);\n        updateGroups(newNodes);\n      }\n    };\n\n    this.onDragNodeMouseDown = (node, event) => {\n      if (node) {\n        const {\n          k,\n          x,\n          y\n        } = this.props.currTrans;\n        const {\n          offsetTop,\n          offsetLeft\n        } = getOffset(this.container.current);\n        const screenX = event.clientX - offsetLeft;\n        const screenY = event.clientY - offsetTop;\n        this.setState(preState => {\n          // 计算鼠标位置在节点中的偏移量\n          return {\n            isDraggingNode: true,\n            dragNode: node,\n            dragNodeOffset: {\n              x: (screenX - x) / k - node.x,\n              y: (screenY - y) / k - node.y\n            }\n          };\n        });\n      }\n    };\n\n    this.onDragNodeMouseMove = event => {\n      event.preventDefault();\n      event.stopPropagation();\n      const {\n        setNodes,\n        nodes,\n        groups\n      } = this.props;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop; // 判断当前节点平移后是否溢出画布\n      // const isOver = this.checkNodeIsOverScreen(dragNode, screenX, screenY);\n      // if (!isOver) {\n\n      this.setState(preState => {\n        const {\n          dragNode,\n          dragNodeOffset\n        } = preState;\n        const newX = (screenX - x) / k - dragNodeOffset.x;\n        const newY = (screenY - y) / k - dragNodeOffset.y;\n        return { ...preState,\n          dragNode: { ...dragNode,\n            x: newX,\n            y: newY\n          }\n        };\n      });\n      const {\n        dragNodeOffset,\n        dragNode\n      } = this.state;\n      setNodes(nodes.map(c => {\n        return c.id === dragNode.id ? { ...c,\n          x: (screenX - x) / k - dragNodeOffset.x,\n          y: (screenY - y) / k - dragNodeOffset.y\n        } : c;\n      }));\n    };\n\n    this.onDragNodeMouseUp = event => {\n      event.stopPropagation();\n      const {\n        groups,\n        updateNodes,\n        updateGroups\n      } = this.props;\n      const {\n        dragNode\n      } = this.state; // 通过是否有groupId来区分是从组中脱离还是拖入组中\n\n      if (groups) {\n        groups.forEach(group => {\n          const {\n            nodes\n          } = group; // 判断根据拖拽的节点有无groupId来属于enter还是leave\n\n          const groupId = dragNode === null || dragNode === void 0 ? void 0 : dragNode.groupId;\n\n          if (groupId) {\n            // 拖出\n            this.handleNodeIsOverGroup(group, dragNode);\n          } else {\n            // 考虑是否在组内\n            if (checkNodeIsOverGroup(dragNode, group, \"enter\") === \"in\") {\n              const newNodes = [...nodes, dragNode]; // 更新组，重新计算组的宽度\n\n              updateGroups(newNodes);\n            } else {\n              updateGroups(nodes);\n            }\n          }\n        });\n      }\n\n      this.setState({\n        isDraggingNode: false\n      });\n    };\n\n    this.onDragGroupMouseDown = (group, event) => {\n      if (group) {\n        const {\n          k,\n          x,\n          y\n        } = this.props.currTrans;\n        const {\n          offsetTop,\n          offsetLeft\n        } = getOffset(this.container.current);\n        const screenX = event.clientX - offsetLeft;\n        const screenY = event.clientY - offsetTop;\n        this.setState(preState => {\n          // 计算鼠标位置在节点中的偏移量\n          return {\n            isDraggingGroup: true,\n            dragGroup: group,\n            dragGroupOffset: {\n              x: (screenX - x) / k - group.x,\n              y: (screenY - y) / k - group.y\n            }\n          };\n        });\n      }\n    };\n\n    this.onDragGroupMouseMove = event => {\n      event.preventDefault();\n      event.stopPropagation();\n      const {\n        setGroups,\n        groups,\n        nodes,\n        setNodes\n      } = this.props;\n      const {\n        k,\n        x,\n        y\n      } = this.props.currTrans;\n      const {\n        offsetTop,\n        offsetLeft\n      } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      let diffX = 0;\n      let diffY = 0;\n      this.setState(preState => {\n        const {\n          dragGroup,\n          dragGroupOffset\n        } = preState;\n        const newX = (screenX - x) / k - dragGroupOffset.x;\n        const newY = (screenY - y) / k - dragGroupOffset.y;\n        diffX = dragGroup.x - newX;\n        diffY = dragGroup.y - newY;\n        return { ...preState,\n          dragGroup: { ...dragGroup,\n            x: newX,\n            y: newY\n          }\n        };\n      });\n      const {\n        dragGroupOffset,\n        dragGroup\n      } = this.state;\n      const newGroups = groups.map(c => {\n        if (c.id === dragGroup.id) {\n          const nodes = c.nodes;\n          return { ...c,\n            x: (screenX - x) / k - dragGroupOffset.x,\n            y: (screenY - y) / k - dragGroupOffset.y,\n            // 更新节点\n            nodes: nodes.map(node => {\n              return { ...node,\n                x: node.x - diffX,\n                y: node.y - diffY\n              };\n            })\n          };\n        } else {\n          return c;\n        }\n      }); // 同时更新nodes\n\n      const newNodes = nodes.map(node => {\n        if (node.groupId === dragGroup.id) {\n          return { ...node,\n            x: node.x - diffX,\n            y: node.y - diffY\n          };\n        } else {\n          return node;\n        }\n      });\n      setNodes(newNodes);\n      setGroups(newGroups);\n    };\n\n    this.onDragGroupMouseUp = event => {\n      event.stopPropagation();\n      const {\n        groups,\n        updateNodes,\n        updateGroups\n      } = this.props;\n      const {\n        dragGroup\n      } = this.state;\n      this.setState({\n        isDraggingGroup: false,\n        dragGroup: null,\n        dragGroupOffset: null\n      });\n    };\n\n    this.getTransformInfo = currTrans => {\n      this.props.setCurrTrans(currTrans);\n    };\n\n    this.getScreenHandler = handleMap => {\n      this.handleApplyTransform = handleMap.handleApplyTransform;\n      this.handleResize = handleMap.handleResize;\n      this.handleResizeTo = handleMap.handleResizeTo;\n      this.handleAdapt = handleMap.handleAdapt;\n      this.screenWidth = handleMap.screenWidth;\n      this.screenHeight = handleMap.screenHeight;\n    };\n\n    this.handleClearActive = () => {\n      this.props.setSelectedLinks([]);\n      this.props.setSelectedNodes([]);\n    };\n\n    this.hasNodeOrLink = (array, node, link) => {\n      let isNodeOrLink = false;\n\n      for (let i = 0; i < array.length; i++) {\n        const inNode = _.includes(array[i].classList, node);\n\n        const inLink = _.includes(array[i].classList, link);\n\n        if (inNode || inLink) {\n          isNodeOrLink = true;\n          break;\n        }\n      }\n\n      return isNodeOrLink;\n    };\n\n    this.changeScreenScale = screenScale => {\n      this.setState({\n        screenScale\n      });\n    };\n\n    this.handleFullScreen = () => {\n      const fullScreen = isFull();\n\n      if (fullScreen) {\n        exitFullscreen();\n      } else {\n        launchFullscreen(this.container.current);\n      }\n    };\n\n    this.handleShowAll = () => {\n      var _$maxBy, _$maxBy2, _$maxBy3, _$maxBy4;\n\n      const {\n        nodes\n      } = this.props;\n\n      if (nodes && nodes.length === 0) {\n        return;\n      } // 组件实际范围\n\n\n      const minX = _.minBy(nodes, c => c.x).x;\n\n      const maxX = ((_$maxBy = _.maxBy(nodes, c => c.x)) === null || _$maxBy === void 0 ? void 0 : _$maxBy.x) + ((_$maxBy2 = _.maxBy(nodes, c => c.x)) === null || _$maxBy2 === void 0 ? void 0 : _$maxBy2.width);\n\n      const minY = _.minBy(nodes, c => c.y).y;\n\n      const maxY = ((_$maxBy3 = _.maxBy(nodes, c => c.y)) === null || _$maxBy3 === void 0 ? void 0 : _$maxBy3.y) + ((_$maxBy4 = _.maxBy(nodes, c => c.y)) === null || _$maxBy4 === void 0 ? void 0 : _$maxBy4.height);\n      const componentWidth = maxX - minX;\n      const componentHeight = maxY - minY; // 先在不缩放的场景下，平移到画布中点\n\n      const x = this.screenWidth / 2 - (minX + maxX) / 2;\n      const y = this.screenHeight / 2 - (minY + maxY) / 2;\n      const transform = zoomIdentity.translate(x, y).scale(1); // 适应画布最大100%，保证在节点少的情况下不发生放大\n\n      const scale = Math.min(this.screenWidth / componentWidth, this.screenHeight / componentHeight, 1); // Todo 待收敛到 ReScreen\n\n      const P0 = [this.screenWidth / 2, this.screenHeight / 2];\n      const P1 = transform.invert(P0);\n      const newTransform = zoomIdentity.translate(P0[0] - P1[0] * scale, P0[1] - P1[1] * scale).scale(scale);\n      this.handleApplyTransform(newTransform);\n    };\n\n    this.layout = () => {\n      var _$maxBy5, _$maxBy6;\n\n      const {\n        nodes,\n        links,\n        setNodes\n      } = this.props;\n\n      if (nodes && nodes.length === 0) {\n        return {\n          nodes,\n          screen: {\n            k: 1,\n            x: 0,\n            y: 0\n          }\n        };\n      }\n\n      const datas = nodes.map(component => {\n        // 兼容 BaseLayout 数据结构\n        component.nodeWidth = component.width;\n        component.nodeHeight = component.height;\n        const downRelations = links.filter(link => {\n          return link.target === component.id;\n        }).map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n        const upRelations = links.filter(link => {\n          return link.source === component.id;\n        }).map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n        return {\n          id: component.id,\n          downRelations,\n          upRelations\n        };\n      });\n      const maxWidth = (_$maxBy5 = _.maxBy(nodes, item => item.width)) === null || _$maxBy5 === void 0 ? void 0 : _$maxBy5.width;\n      const maxHeight = (_$maxBy6 = _.maxBy(nodes, item => item.height)) === null || _$maxBy6 === void 0 ? void 0 : _$maxBy6.height;\n      const dag = new BaseLayout.DAG({\n        isTransverse: true,\n        padding: 20,\n        margin: {\n          left: 0,\n          right: 0,\n          top: 0,\n          bottom: 0\n        },\n        defaultNodeWidth: maxWidth,\n        defaultNodeHeight: maxHeight\n      });\n      const {\n        nodes: newNodes\n      } = dag.getMultiDAG(datas);\n      const layoutNodes = nodes.map(component => {\n        const node = _.find(newNodes, n => n.id === component.id);\n\n        return { ...component,\n          x: node.view.x,\n          y: node.view.y\n        };\n      });\n      setNodes(layoutNodes);\n    };\n\n    this.onSelectLink = key => {\n      const {\n        selectedLinks,\n        setSelectedLinks\n      } = this.props;\n\n      if (selectedLinks) {\n        // 若连线已高线，则取消高亮状态\n        const index = _.findIndex(selectedLinks, link => link === key);\n\n        if (index > -1) {\n          setSelectedLinks([...selectedLinks.slice(0, index), ...selectedLinks.slice(index + 1)]);\n        } else {\n          setSelectedLinks([...selectedLinks, key]);\n        }\n      } else {\n        setSelectedLinks([key]);\n      }\n    };\n\n    this.onClickNode = currentNode => {\n      const {\n        selectedNodes,\n        setSelectedNodes,\n        setSelectedLinks,\n        isKeyPressing\n      } = this.props; // 区分多选按钮是否按下\n\n      if (isKeyPressing) {\n        if (selectedNodes) {\n          // 若节点已被点击则清除点击状态\n          const index = _.findIndex(selectedNodes, id => id === currentNode.id);\n\n          if (index > -1) {\n            setSelectedNodes([...selectedNodes.slice(0, index), ...selectedNodes.slice(index + 1)]);\n          } else {\n            setSelectedNodes(_.compact([...selectedNodes, currentNode.id]));\n          }\n        } else {\n          setSelectedNodes([currentNode.id]);\n        }\n      } else {\n        setSelectedNodes([currentNode.id]); // 清空高亮的连线\n\n        setSelectedLinks(null);\n      }\n    };\n\n    this.onSelectNode = (currentNode, key) => {\n      const {\n        selectedNodes,\n        deleteNodes\n      } = this.props;\n\n      if (key === OperateType.delete) {\n        // 删除组件以及删除连线\n        // 判断改节点是否在多选区域内\n        if (selectedNodes && selectedNodes.includes(currentNode.id)) {\n          deleteNodes(_.compact([...selectedNodes, currentNode.id]));\n        } else {\n          deleteNodes([currentNode.id]);\n        }\n      }\n    };\n\n    this.onContextMenuLink = (key, event) => {\n      event.preventDefault();\n      event.stopPropagation();\n      this.props.setSelectedLinks([key]); // 清空高亮的组件\n\n      this.props.setSelectedNodes(null);\n      const currentPos = {\n        x: event.clientX,\n        y: event.clientY\n      };\n      this.setState({\n        deleteVisible: true,\n        menuPos: currentPos\n      });\n    };\n\n    this.onResize = (node, width, height, x, y) => {\n      const {\n        updateNodes\n      } = this.props;\n      const newNode = { ...node,\n        width,\n        height,\n        x,\n        y\n      };\n      updateNodes(newNode);\n    };\n\n    this.renderCanvas = () => {\n      const {\n        currentHoverNode\n      } = this.state;\n      const {\n        nodes,\n        links,\n        selectedNodes,\n        selectedLinks,\n        groups\n      } = this.props;\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"editor-view\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 957,\n          columnNumber: 7\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"editor-view-content\",\n        ref: this.nodesContainerRef,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 958,\n          columnNumber: 9\n        }\n      }, (nodes || []).map(child => {\n        const id = child === null || child === void 0 ? void 0 : child.id;\n        const isSelected = selectedNodes ? selectedNodes.includes(id) : false;\n        const showSelector = isSelected || currentHoverNode === id;\n        return /*#__PURE__*/React.createElement(EditorNode, {\n          nodeRef: child.ref,\n          currentNode: child,\n          key: id,\n          onClick: this.onClickNode,\n          isSelected: isSelected,\n          showSelector: showSelector,\n          onResize: this.onResize.bind(this, child),\n          currTrans: this.props.currTrans,\n          onSelect: this.onSelectNode,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 966,\n            columnNumber: 15\n          }\n        });\n      }), (groups || []).map(child => {\n        const id = child === null || child === void 0 ? void 0 : child.id;\n        const nodesInGroup = child === null || child === void 0 ? void 0 : child.nodes;\n        return /*#__PURE__*/React.createElement(EditorGroup, {\n          key: id,\n          id: id,\n          groupRef: child === null || child === void 0 ? void 0 : child.ref,\n          currentGroup: child,\n          nodes: nodesInGroup,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 984,\n            columnNumber: 15\n          }\n        });\n      }), /*#__PURE__*/React.createElement(EditorEdges, {\n        links: links,\n        nodes: nodes,\n        selectedLinks: selectedLinks,\n        onContextMenu: this.onContextMenuLink,\n        onSelectLink: this.onSelectLink,\n        isDraggingLink: this.state.isDraggingLink,\n        dragLink: this.state.dragLink,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 994,\n          columnNumber: 11\n        }\n      })));\n    };\n\n    this.state = {\n      isDraggingNode: false,\n      isDraggingLink: false,\n      isDraggingGroup: false,\n      dragNode: null,\n      dragLink: null,\n      dragGroup: null,\n      dragNodeOffset: null,\n      dragGroupOffset: null,\n      menuDisplay: false,\n      menuPos: {\n        id: \"\",\n        x: 0,\n        y: 0\n      },\n      screenScale: 100,\n      sourcePos: \"\",\n      currentHoverNode: \"\",\n      deleteVisible: false\n    };\n    this.nodesContainerRef = React.createRef();\n    this.container = React.createRef();\n  }\n\n  componentDidMount() {\n    this.nodesContainerRef.current.addEventListener(\"mousedown\", this.onNodesContainerMouseDown);\n    this.container.current.addEventListener(\"contextmenu\", this.openContainerMenu);\n    this.container.current.addEventListener(\"click\", this.onContainerMouseDown); // 初始化布局\n\n    this.handleApplyTransform(zoomIdentity);\n  }\n\n  componentWillUnmount() {\n    this.nodesContainerRef.current.removeEventListener(\"mousedown\", this.onNodesContainerMouseDown);\n    this.container.current.removeEventListener(\"contextmenu\", this.openContainerMenu);\n    this.container.current.removeEventListener(\"click\", this.onContainerMouseDown);\n  }\n\n  componentWillUpdate(nextProps, nextState) {\n    if (this.state.isDraggingNode !== nextState.isDraggingNode) {\n      this.toggleDragNode(nextState.isDraggingNode);\n    }\n\n    if (this.state.isDraggingLink !== nextState.isDraggingLink) {\n      this.toggleDragLink(nextState.isDraggingLink);\n    }\n\n    if (this.state.isDraggingGroup !== nextState.isDraggingGroup) {\n      this.toggleDragGroup(nextState.isDraggingGroup);\n    }\n\n    if (nextProps.groups !== this.props.groups) {\n      this.forceUpdate();\n    }\n  }\n  /** 打开全局操作菜单，包括复制，粘贴，删除等 */\n\n\n  onDrag(event, name) {}\n\n  onDrop(event) {\n    const {\n      setNodes,\n      nodes,\n      dragNode\n    } = this.props;\n    const {\n      offsetTop,\n      offsetLeft\n    } = getOffset(this.container.current); // 计算滚动条的位置\n\n    const scrollLeft = document.documentElement.scrollLeft + document.querySelector(\"#root\").scrollLeft;\n    const scrollTop = document.documentElement.scrollTop + document.querySelector(\"#root\").scrollTop;\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n    const {\n      k,\n      x,\n      y\n    } = this.props.currTrans;\n\n    if (dragNode) {\n      // 新添加了chart属性\n      const {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart\n      } = dragNode;\n      const newNode = {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart,\n        x: (screenX - x) / k - NODE_WIDTH / 2,\n        y: (screenY - y) / k - NODE_HEIGHT / 2,\n        id: uuid.v4(),\n        ref: React.createRef()\n      };\n      setNodes([...nodes, newNode]);\n    }\n  }\n  /** 清空高亮组件和连线 */\n\n\n  render() {\n    const {\n      deleteVisible,\n      menuPos\n    } = this.state;\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"canvas-container-content\",\n      ref: this.container,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1011,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(ReScreen, {\n      type: \"DOM\",\n      getScreenHandler: this.getScreenHandler,\n      needMinimap: true,\n      needRefresh: true,\n      zoomEnabled: false,\n      mapPosition: \"RT\",\n      mapWidth: 200,\n      mapHeight: 300,\n      height: 500,\n      width: 800,\n      screenHeight: 900,\n      screenWidth: 600,\n      mapRectStyle: {\n        stroke: \"#468CFF\",\n        fill: \"transparent\",\n        strokeWidth: 1.5\n      },\n      focusEnabled: 2,\n      onScreenChange: this.getTransformInfo,\n      onDragOver: event => {\n        event.preventDefault();\n      },\n      onDrop: this.onDrop.bind(this),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1012,\n        columnNumber: 9\n      }\n    }, this.renderCanvas()), /*#__PURE__*/React.createElement(ContextMenu, {\n      visible: deleteVisible // onHide={() => {\n      //   this.props.setLinks(null);\n      //   this.setState({\n      //     deleteVisible: false\n      //   });\n      // }}\n      ,\n      left: menuPos.x,\n      top: menuPos.y // onClick={this.handleDeleteLinks.bind(this, selectedLinks)}\n      ,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1040,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(Menu, {\n      getPopupContainer: triggerNode => triggerNode.parentNode,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 1052,\n        columnNumber: 11\n      }\n    }, [{\n      name: \"删除\",\n      key: OperateType.delete\n    }].map(child => {\n      return /*#__PURE__*/React.createElement(Menu.Item, {\n        key: child.key,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 1061,\n          columnNumber: 22\n        }\n      }, child.name);\n    }))));\n  }\n\n}","map":{"version":3,"sources":["/Users/majy/work/bici/code/editor-demo/src/features/editor/common/CanvasContent.tsx"],"names":["React","_","uuid","ReScreen","BaseLayout","zoomIdentity","Menu","EditorNode","EditorGroup","EditorEdges","ContextMenu","CONNECTOR","OperateType","NODE_WIDTH","NODE_HEIGHT","LINK_AREA","findNearbyNode","calcLinkPosition","checkNodeIsOverGroup","exitFullscreen","launchFullscreen","isFull","getOffset","CanvasContentProps","ref","nodes","links","groups","setNodes","setLinks","setGroups","selectedLinks","setSelectedLinks","selectedNodes","setSelectedNodes","dragNode","updateNodes","updateLinks","updateGroups","deleteNodes","deleteLinks","copiedNodes","setCopiedNodes","currTrans","setCurrTrans","isKeyPressing","CanvasContentState","isDraggingNode","isDraggingLink","isDraggingGroup","dragGroup","dragNodeOffset","dragGroupOffset","dragLink","sourcePos","menuDisplay","menuPos","screenScale","currentHoverNode","deleteVisible","CanvasContent","Component","constructor","props","nodesContainerRef","container","screenWidth","screenHeight","handleApplyTransform","handleResize","handleAdapt","handleResizeTo","openContainerMenu","event","preventDefault","toggleDragGroup","window","addEventListener","onDragGroupMouseMove","onDragGroupMouseUp","removeEventListener","toggleDragNode","onDragNodeMouseMove","onDragNodeMouseUp","toggleDragLink","onDragLinkMouseMove","onDragLinkMouseUp","stopPropagation","offsetTop","offsetLeft","current","scrollLeft","document","documentElement","querySelector","scrollTop","screenX","clientX","screenY","clientY","k","x","y","setState","preState","onNodesContainerMouseDown","length","currentNode","find","c","contains","target","type","dataset","position","onDragLinkMouseDown","onDragNodeMouseDown","currentGroup","onDragGroupMouseDown","onContainerMouseDown","path","isNodeOrLink","hasNodeOrLink","handleClearActive","onNodesContainerMouseMove","id","node","originId","originX","originY","state","nearNode","targetNode","targetPos","newLink","source","handleNodeIsOverGroup","groupId","newNodes","filter","map","newX","newY","forEach","group","diffX","diffY","newGroups","getTransformInfo","getScreenHandler","handleMap","array","link","i","inNode","includes","classList","inLink","changeScreenScale","handleFullScreen","fullScreen","handleShowAll","minX","minBy","maxX","maxBy","width","minY","maxY","height","componentWidth","componentHeight","transform","translate","scale","Math","min","P0","P1","invert","newTransform","layout","screen","datas","component","nodeWidth","nodeHeight","downRelations","sourceId","targetId","upRelations","maxWidth","item","maxHeight","dag","DAG","isTransverse","padding","margin","left","right","top","bottom","defaultNodeWidth","defaultNodeHeight","getMultiDAG","layoutNodes","n","view","onSelectLink","key","index","findIndex","slice","onClickNode","compact","onSelectNode","delete","onContextMenuLink","currentPos","onResize","newNode","renderCanvas","child","isSelected","showSelector","bind","nodesInGroup","createRef","componentDidMount","componentWillUnmount","componentWillUpdate","nextProps","nextState","forceUpdate","onDrag","name","onDrop","chart","v4","render","stroke","fill","strokeWidth","triggerNode","parentNode"],"mappings":"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","sourcesContent":["/**\n * @file 处理画布内的操作\n */\n\nimport * as React from \"react\";\nimport * as _ from \"lodash\";\nimport * as uuid from \"uuid\";\nimport { ReScreen, BaseLayout } from \"regraph-next\";\nimport { ZoomTransform, zoomIdentity } from \"d3-zoom\";\nimport { Menu } from \"antd\";\nimport { EditorNode } from \"./EditorNode\";\nimport { EditorGroup } from \"./EditorGroup\";\nimport { EditorEdges } from \"./EditorEdges\";\nimport { ContextMenu } from \"./ContextMenu\";\nimport {\n  MenuPos,\n  CONNECTOR,\n  OperateType,\n  Link,\n  Node,\n  Group,\n  NODE_WIDTH,\n  NODE_HEIGHT,\n  LINK_AREA\n} from \"../constants/defines\";\nimport {\n  findUpstreamNode,\n  findAllUpstreamNodes,\n  findDownstreamNode,\n  findAllDownstreamNodes,\n  findAllDownstreamLinks,\n  findNearbyNode\n} from \"../utils/find\";\nimport { calcLinkPosition } from \"../utils/calc\";\nimport { pointInPoly, checkNodeIsOverGroup } from \"../utils/layout\";\nimport { exitFullscreen, launchFullscreen, isFull, getOffset } from \"./utils\";\n\nclass CanvasContentProps {\n  ref: any;\n  nodes: Node[];\n  links: Link[];\n  groups: Group[];\n  setNodes: (nodes: Node[]) => void;\n  setLinks: (links: Link[]) => void;\n  setGroups?: (groups: Group[]) => void;\n  selectedLinks: string[];\n  setSelectedLinks: (links: string[]) => void;\n  selectedNodes: string[];\n  setSelectedNodes: (links: string[]) => void;\n  /** 当前拖拽的节点 */\n  dragNode: Node;\n  updateNodes: (node: Node) => void;\n  updateLinks: (link: Link) => void;\n  updateGroups?: (nodes: Node[], deleteGroupId?: string) => void;\n  deleteNodes: (selectedNodes: string[]) => void;\n  deleteLinks: (selectedLinks: string[]) => void;\n  copiedNodes: Node[];\n  setCopiedNodes: (nodes: Node[]) => void;\n  currTrans: ZoomTransform;\n  setCurrTrans: (transform: ZoomTransform) => void;\n  /** 是否被按住 */\n  isKeyPressing: boolean;\n}\n\nclass CanvasContentState {\n  /** 拖拽节点 */\n  isDraggingNode: boolean;\n  /** 拖拽边 */\n  isDraggingLink: boolean;\n  /** 拖拽组 */\n  isDraggingGroup: boolean;\n  /** 拖拽组 */\n  dragGroup: Group;\n  /** 拖拽节点 */\n  dragNode: Node;\n  /** 鼠标位置在拖动节点的偏移量 */\n  dragNodeOffset: any;\n  /** 鼠标位置在拖动组的偏移量 */\n  dragGroupOffset: any;\n  /** 移动边 */\n  dragLink: {\n    /** 源起节点id */\n    originId: string;\n    /** 源起节点 */\n    originX: number;\n    originY: number;\n    /** 鼠标移动节点 */\n    x: number;\n    y: number;\n    /** 来源边位置 */\n  };\n  sourcePos: string;\n  /** 对话框展示标志位 */\n  menuDisplay: boolean;\n  /** 对话框的位置信息 */\n  menuPos: MenuPos;\n  /** 画布的放大倍率 */\n  screenScale: number;\n  /** 当前鼠标悬浮的节点 */\n  currentHoverNode: string;\n  /** 删除框 */\n  deleteVisible: boolean;\n}\n\nexport default class CanvasContent extends React.Component<\n  CanvasContentProps,\n  CanvasContentState\n> {\n  nodesContainerRef: any;\n  container: any;\n  screenWidth: number;\n  screenHeight: number;\n\n  handleApplyTransform: (transform: ZoomTransform) => void;\n  handleResize: (isLarge: boolean) => void;\n  handleAdapt: () => void;\n  handleResizeTo: (scale: number, P0?: [number, number]) => void;\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      isDraggingNode: false,\n      isDraggingLink: false,\n      isDraggingGroup: false,\n      dragNode: null,\n      dragLink: null,\n      dragGroup: null,\n      dragNodeOffset: null,\n      dragGroupOffset: null,\n      menuDisplay: false,\n      menuPos: {\n        id: \"\",\n        x: 0,\n        y: 0\n      },\n      screenScale: 100,\n      sourcePos: \"\",\n      currentHoverNode: \"\",\n      deleteVisible: false\n    };\n    this.nodesContainerRef = React.createRef();\n    this.container = React.createRef();\n  }\n\n  componentDidMount() {\n    this.nodesContainerRef.current.addEventListener(\n      \"mousedown\",\n      this.onNodesContainerMouseDown\n    );\n    this.container.current.addEventListener(\n      \"contextmenu\",\n      this.openContainerMenu\n    );\n    this.container.current.addEventListener(\"click\", this.onContainerMouseDown);\n\n    // 初始化布局\n    this.handleApplyTransform(zoomIdentity);\n  }\n\n  componentWillUnmount() {\n    this.nodesContainerRef.current.removeEventListener(\n      \"mousedown\",\n      this.onNodesContainerMouseDown\n    );\n    this.container.current.removeEventListener(\n      \"contextmenu\",\n      this.openContainerMenu\n    );\n    this.container.current.removeEventListener(\n      \"click\",\n      this.onContainerMouseDown\n    );\n  }\n\n  componentWillUpdate(\n    nextProps: CanvasContentProps,\n    nextState: CanvasContentState\n  ) {\n    if (this.state.isDraggingNode !== nextState.isDraggingNode) {\n      this.toggleDragNode(nextState.isDraggingNode);\n    }\n    if (this.state.isDraggingLink !== nextState.isDraggingLink) {\n      this.toggleDragLink(nextState.isDraggingLink);\n    }\n    if (this.state.isDraggingGroup !== nextState.isDraggingGroup) {\n      this.toggleDragGroup(nextState.isDraggingGroup);\n    }\n    if (nextProps.groups !== this.props.groups) {\n      this.forceUpdate();\n    }\n  }\n\n  /** 打开全局操作菜单，包括复制，粘贴，删除等 */\n  openContainerMenu = (event: any) => {\n    event.preventDefault();\n  };\n\n  toggleDragGroup = (isDraggingGroup: Boolean) => {\n    if (isDraggingGroup) {\n      window.addEventListener(\"mousemove\", this.onDragGroupMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragGroupMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragGroupMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragGroupMouseUp);\n    }\n  };\n\n  toggleDragNode = (isDraggingNode: Boolean) => {\n    if (isDraggingNode) {\n      window.addEventListener(\"mousemove\", this.onDragNodeMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragNodeMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragNodeMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragNodeMouseUp);\n    }\n  };\n\n  toggleDragLink = (isDraggingLink: Boolean) => {\n    if (isDraggingLink) {\n      window.addEventListener(\"mousemove\", this.onDragLinkMouseMove);\n      window.addEventListener(\"mouseup\", this.onDragLinkMouseUp);\n    } else {\n      window.removeEventListener(\"mousemove\", this.onDragLinkMouseMove);\n      window.removeEventListener(\"mouseup\", this.onDragLinkMouseUp);\n    }\n  };\n\n  onDragLinkMouseMove = (event: any) => {\n    event.stopPropagation();\n    event.preventDefault();\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    this.setState(preState => {\n      const { dragLink } = preState;\n      return {\n        dragLink: {\n          ...dragLink,\n          x: (screenX - x) / k,\n          y: (screenY - y) / k\n        }\n      };\n    });\n  };\n\n  /** 监听整个区域，提升性能 */\n  onNodesContainerMouseDown = (event: any) => {\n    event.stopPropagation();\n    const { nodes, groups } = this.props;\n    if (nodes && nodes.length > 0) {\n      const currentNode = _.find(nodes, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      });\n\n      const type = event.target.dataset && event.target.dataset.type;\n      const position = event.target.dataset && event.target.dataset.position;\n\n      if (currentNode) {\n        if (type === \"edge\" && position) {\n          /** 拖拽连线 */\n          this.onDragLinkMouseDown(currentNode as any, position);\n          return;\n        } else if (type === \"resize\") {\n          return;\n        } else {\n          /** 拖拽节点，排除resize节点 */\n          this.onDragNodeMouseDown(currentNode as any, event);\n        }\n      }\n    }\n\n    if (groups && groups.length > 0) {\n      const currentGroup = _.find(groups, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      });\n      this.onDragGroupMouseDown(currentGroup as any, event);\n    }\n  };\n\n  /** 监听整个容器click事件 */\n  onContainerMouseDown = (event: any) => {\n    // event.stopPropagation();\n\n    // 过滤掉节点和边\n    const path = event.path;\n    const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n    if (!isNodeOrLink) {\n      // 清空高亮的节点和边\n      this.handleClearActive();\n    }\n  };\n\n  /** 监听整个容器mousemove 事件 */\n  onNodesContainerMouseMove = (event: any) => {\n    event.preventDefault();\n    const path = event.path;\n    const isNodeOrLink = this.hasNodeOrLink(path, \"editor-node\", \"editor-link\");\n    const { nodes } = this.props;\n\n    if (nodes && nodes.length > 0) {\n      const currentNode = _.find(nodes, c => {\n        if (c.ref && c.ref.current) {\n          return c.ref.current.contains(event.target);\n        }\n        return false;\n      }) as Node;\n\n      if (currentNode) {\n        if (isNodeOrLink) {\n          this.setState({\n            currentHoverNode: currentNode.id\n          });\n        } else {\n          this.setState({\n            currentHoverNode: \"\"\n          });\n        }\n      }\n    }\n  };\n\n  /** 鼠标按下，进行连线 */\n  onDragLinkMouseDown = (node: Node, position: string) => {\n    const { x, y } = calcLinkPosition(node, position);\n    this.setState({\n      isDraggingLink: true,\n      dragLink: {\n        originId: node.id,\n        originX: x,\n        originY: y,\n        x,\n        y\n      },\n      sourcePos: position\n    });\n  };\n\n  /** 鼠标抬起，连线结束 */\n  onDragLinkMouseUp = (event: any) => {\n    const { setLinks, links, nodes } = this.props;\n    const { dragLink } = this.state;\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const nearNode = findNearbyNode(\n      {\n        x: (screenX - x) / k,\n        y: (screenY - y) / k\n      },\n      nodes,\n      LINK_AREA\n    );\n\n    // 需要找到链接的是哪个节点\n\n    if (nearNode) {\n      const { targetNode, targetPos } = nearNode;\n      const newLink = {\n        id:\n          dragLink.originId + CONNECTOR + targetNode.id + CONNECTOR + targetPos,\n        source: dragLink.originId,\n        target: targetNode.id,\n        sourcePos: this.state.sourcePos,\n        targetPos\n      };\n      setLinks([...links, newLink]);\n    }\n\n    this.setState({\n      isDraggingLink: false,\n      dragLink: null,\n      sourcePos: \"\"\n    });\n  };\n\n  /** 处理节点与组的关系 */\n  handleNodeIsOverGroup = (currentGroup: Group, dragNode: Node) => {\n    const { updateNodes, updateGroups } = this.props;\n\n    if (checkNodeIsOverGroup(dragNode, currentGroup, \"leave\") === \"out\") {\n      // 该节点是否在组外\n      //console.log(\"leave out\", dragNode);\n      updateNodes({ ...dragNode, groupId: \"\" });\n      const newNodes = currentGroup.nodes.filter(\n        node => node.id !== dragNode.id\n      );\n      // 更新组，重新计算组的宽度\n      updateGroups(newNodes, dragNode.groupId);\n    } else {\n      //console.log(\"leave in\");\n      // 改变组的大小\n      const newNodes = currentGroup.nodes.map(node =>\n        node.id === dragNode.id ? dragNode : node\n      );\n      updateGroups(newNodes);\n    }\n  };\n\n  /** 按下节点 */\n  onDragNodeMouseDown = (node: Node, event: any) => {\n    if (node) {\n      const { k, x, y } = this.props.currTrans;\n\n      const { offsetTop, offsetLeft } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      this.setState(preState => {\n        // 计算鼠标位置在节点中的偏移量\n        return {\n          isDraggingNode: true,\n          dragNode: node,\n          dragNodeOffset: {\n            x: (screenX - x) / k - node.x,\n            y: (screenY - y) / k - node.y\n          }\n        };\n      });\n    }\n  };\n\n  /** 移动节点 */\n  onDragNodeMouseMove = (event: any) => {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const { setNodes, nodes, groups } = this.props;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    const screenX = event.clientX - offsetLeft;\n    const screenY = event.clientY - offsetTop;\n\n    // 判断当前节点平移后是否溢出画布\n    // const isOver = this.checkNodeIsOverScreen(dragNode, screenX, screenY);\n\n    // if (!isOver) {\n    this.setState(preState => {\n      const { dragNode, dragNodeOffset } = preState;\n\n      const newX = (screenX - x) / k - dragNodeOffset.x;\n      const newY = (screenY - y) / k - dragNodeOffset.y;\n\n      return {\n        ...preState,\n        dragNode: {\n          ...dragNode,\n          x: newX,\n          y: newY\n        }\n      };\n    });\n\n    const { dragNodeOffset, dragNode } = this.state;\n\n    setNodes(\n      nodes.map(c => {\n        return c.id === dragNode.id\n          ? {\n              ...c,\n              x: (screenX - x) / k - dragNodeOffset.x,\n              y: (screenY - y) / k - dragNodeOffset.y\n            }\n          : c;\n      })\n    );\n  };\n\n  /** 放开节点 */\n  onDragNodeMouseUp = (event: any) => {\n    event.stopPropagation();\n    const { groups, updateNodes, updateGroups } = this.props;\n\n    const { dragNode } = this.state;\n    // 通过是否有groupId来区分是从组中脱离还是拖入组中\n    if (groups) {\n      groups.forEach(group => {\n        const { nodes } = group;\n\n        // 判断根据拖拽的节点有无groupId来属于enter还是leave\n        const groupId = dragNode?.groupId;\n        if (groupId) {\n          // 拖出\n          this.handleNodeIsOverGroup(group, dragNode);\n        } else {\n          // 考虑是否在组内\n          if (checkNodeIsOverGroup(dragNode, group, \"enter\") === \"in\") {\n            const newNodes = [...nodes, dragNode];\n            // 更新组，重新计算组的宽度\n            updateGroups(newNodes);\n          } else {\n            updateGroups(nodes);\n          }\n        }\n      });\n    }\n\n    this.setState({\n      isDraggingNode: false\n    });\n  };\n\n  /** 按下组 */\n  onDragGroupMouseDown = (group: Group, event: any) => {\n    if (group) {\n      const { k, x, y } = this.props.currTrans;\n\n      const { offsetTop, offsetLeft } = getOffset(this.container.current);\n      const screenX = event.clientX - offsetLeft;\n      const screenY = event.clientY - offsetTop;\n      this.setState(preState => {\n        // 计算鼠标位置在节点中的偏移量\n        return {\n          isDraggingGroup: true,\n          dragGroup: group,\n          dragGroupOffset: {\n            x: (screenX - x) / k - group.x,\n            y: (screenY - y) / k - group.y\n          }\n        };\n      });\n    }\n  };\n\n  /** 移动组 */\n  onDragGroupMouseMove = (event: any) => {\n    event.preventDefault();\n    event.stopPropagation();\n\n    const { setGroups, groups, nodes, setNodes } = this.props;\n\n    const { k, x, y } = this.props.currTrans;\n\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    const screenX = event.clientX - offsetLeft;\n    const screenY = event.clientY - offsetTop;\n    let diffX = 0;\n    let diffY = 0;\n\n    this.setState(preState => {\n      const { dragGroup, dragGroupOffset } = preState;\n\n      const newX = (screenX - x) / k - dragGroupOffset.x;\n      const newY = (screenY - y) / k - dragGroupOffset.y;\n\n      diffX = dragGroup.x - newX;\n      diffY = dragGroup.y - newY;\n\n      return {\n        ...preState,\n        dragGroup: {\n          ...dragGroup,\n          x: newX,\n          y: newY\n        }\n      };\n    });\n\n    const { dragGroupOffset, dragGroup } = this.state;\n\n    const newGroups = groups.map(c => {\n      if (c.id === dragGroup.id) {\n        const nodes = c.nodes;\n        return {\n          ...c,\n          x: (screenX - x) / k - dragGroupOffset.x,\n          y: (screenY - y) / k - dragGroupOffset.y,\n          // 更新节点\n          nodes: nodes.map(node => {\n            return {\n              ...node,\n              x: node.x - diffX,\n              y: node.y - diffY\n            };\n          })\n        };\n      } else {\n        return c;\n      }\n    });\n    // 同时更新nodes\n\n    const newNodes = nodes.map(node => {\n      if (node.groupId === dragGroup.id) {\n        return {\n          ...node,\n          x: node.x - diffX,\n          y: node.y - diffY\n        };\n      } else {\n        return node;\n      }\n    });\n    setNodes(newNodes);\n    setGroups(newGroups);\n  };\n\n  /** 放开组 */\n  onDragGroupMouseUp = (event: any) => {\n    event.stopPropagation();\n    const { groups, updateNodes, updateGroups } = this.props;\n\n    const { dragGroup } = this.state;\n\n    this.setState({\n      isDraggingGroup: false,\n      dragGroup: null,\n      dragGroupOffset: null\n    });\n  };\n\n  getTransformInfo = (currTrans: ZoomTransform) => {\n    this.props.setCurrTrans(currTrans);\n  };\n\n  getScreenHandler = handleMap => {\n    this.handleApplyTransform = handleMap.handleApplyTransform;\n    this.handleResize = handleMap.handleResize;\n    this.handleResizeTo = handleMap.handleResizeTo;\n    this.handleAdapt = handleMap.handleAdapt;\n    this.screenWidth = handleMap.screenWidth;\n    this.screenHeight = handleMap.screenHeight;\n  };\n\n  onDrag(event, name: string) {}\n\n  onDrop(event: React.DragEvent<HTMLDivElement>) {\n    const { setNodes, nodes, dragNode } = this.props;\n    const { offsetTop, offsetLeft } = getOffset(this.container.current);\n    // 计算滚动条的位置\n    const scrollLeft =\n      document.documentElement.scrollLeft +\n      document.querySelector(\"#root\").scrollLeft;\n    const scrollTop =\n      document.documentElement.scrollTop +\n      document.querySelector(\"#root\").scrollTop;\n\n    const screenX = event.clientX - offsetLeft + scrollLeft;\n    const screenY = event.clientY - offsetTop + scrollTop;\n\n    const { k, x, y } = this.props.currTrans;\n\n    if (dragNode) {\n      // 新添加了chart属性\n      const { key, name, type, width, height,chart } = dragNode;\n\n      const newNode = {\n        key,\n        name,\n        type,\n        width,\n        height,\n        chart,\n        x: (screenX - x) / k - NODE_WIDTH / 2,\n        y: (screenY - y) / k - NODE_HEIGHT / 2,\n        id: uuid.v4(),\n        ref: React.createRef()\n      };\n\n      setNodes([...nodes, newNode]);\n    }\n  }\n\n  /** 清空高亮组件和连线 */\n  handleClearActive = () => {\n    this.props.setSelectedLinks([]);\n    this.props.setSelectedNodes([]);\n  };\n\n  /** 判断点击的节点是否为节点和边 */\n  hasNodeOrLink = (array: any[], node?: string, link?: string) => {\n    let isNodeOrLink = false;\n\n    for (let i = 0; i < array.length; i++) {\n      const inNode = _.includes(array[i].classList, node);\n      const inLink = _.includes(array[i].classList, link);\n\n      if (inNode || inLink) {\n        isNodeOrLink = true;\n        break;\n      }\n    }\n    return isNodeOrLink;\n  };\n\n  /** 改变缩放倍率 */\n  changeScreenScale = (screenScale: number) => {\n    this.setState({\n      screenScale\n    });\n  };\n\n  /** 处理全屏事件 */\n  handleFullScreen = () => {\n    const fullScreen = isFull();\n    if (fullScreen) {\n      exitFullscreen();\n    } else {\n      launchFullscreen(this.container.current);\n    }\n  };\n\n  /** 适应画布 */\n  handleShowAll = () => {\n    const { nodes } = this.props;\n\n    if (nodes && nodes.length === 0) {\n      return;\n    }\n\n    // 组件实际范围\n    const minX = _.minBy(nodes, c => c.x).x;\n    const maxX = _.maxBy(nodes, c => c.x)?.x + _.maxBy(nodes, c => c.x)?.width;\n    const minY = _.minBy(nodes, c => c.y).y;\n    const maxY = _.maxBy(nodes, c => c.y)?.y + _.maxBy(nodes, c => c.y)?.height;\n\n    const componentWidth = maxX - minX;\n    const componentHeight = maxY - minY;\n\n    // 先在不缩放的场景下，平移到画布中点\n    const x = this.screenWidth / 2 - (minX + maxX) / 2;\n    const y = this.screenHeight / 2 - (minY + maxY) / 2;\n    const transform = zoomIdentity.translate(x, y).scale(1);\n    // 适应画布最大100%，保证在节点少的情况下不发生放大\n    const scale = Math.min(\n      this.screenWidth / componentWidth,\n      this.screenHeight / componentHeight,\n      1\n    );\n    // Todo 待收敛到 ReScreen\n    const P0 = [this.screenWidth / 2, this.screenHeight / 2] as [\n      number,\n      number\n    ];\n    const P1 = transform.invert(P0);\n    const newTransform = zoomIdentity\n      .translate(P0[0] - P1[0] * scale, P0[1] - P1[1] * scale)\n      .scale(scale);\n    this.handleApplyTransform(newTransform);\n  };\n\n  /** 格式化画布 */\n  layout = () => {\n    const { nodes, links, setNodes } = this.props;\n    if (nodes && nodes.length === 0) {\n      return {\n        nodes,\n        screen: {\n          k: 1,\n          x: 0,\n          y: 0\n        }\n      };\n    }\n\n    const datas = nodes.map(component => {\n      // 兼容 BaseLayout 数据结构\n      (component as any).nodeWidth = component.width;\n      (component as any).nodeHeight = component.height;\n      const downRelations = links\n        .filter(link => {\n          return link.target === component.id;\n        })\n        .map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n      const upRelations = links\n        .filter(link => {\n          return link.source === component.id;\n        })\n        .map(link => {\n          return {\n            sourceId: link.source,\n            targetId: link.target\n          };\n        });\n      return {\n        id: component.id,\n        downRelations,\n        upRelations\n      };\n    });\n\n    const maxWidth = _.maxBy(nodes, item => item.width)?.width;\n    const maxHeight = _.maxBy(nodes, item => item.height)?.height;\n\n    const dag = new BaseLayout.DAG({\n      isTransverse: true,\n      padding: 20,\n      margin: {\n        left: 0,\n        right: 0,\n        top: 0,\n        bottom: 0\n      },\n      defaultNodeWidth: maxWidth,\n      defaultNodeHeight: maxHeight\n    });\n\n    const { nodes: newNodes } = dag.getMultiDAG(datas);\n\n    const layoutNodes = nodes.map(component => {\n      const node = _.find(newNodes, n => n.id === component.id);\n\n      return {\n        ...component,\n        x: node.view.x,\n        y: node.view.y\n      };\n    });\n    setNodes(layoutNodes);\n  };\n\n  /** 点击连线 */\n  onSelectLink = (key: string) => {\n    const { selectedLinks, setSelectedLinks } = this.props;\n    if (selectedLinks) {\n      // 若连线已高线，则取消高亮状态\n      const index = _.findIndex(selectedLinks, link => link === key);\n      if (index > -1) {\n        setSelectedLinks([\n          ...selectedLinks.slice(0, index),\n          ...selectedLinks.slice(index + 1)\n        ]);\n      } else {\n        setSelectedLinks([...selectedLinks, key]);\n      }\n    } else {\n      setSelectedLinks([key]);\n    }\n  };\n\n  /** 点击节点 */\n  onClickNode = (currentNode: Node) => {\n    const {\n      selectedNodes,\n      setSelectedNodes,\n      setSelectedLinks,\n      isKeyPressing\n    } = this.props;\n\n    // 区分多选按钮是否按下\n    if (isKeyPressing) {\n      if (selectedNodes) {\n        // 若节点已被点击则清除点击状态\n        const index = _.findIndex(selectedNodes, id => id === currentNode.id);\n\n        if (index > -1) {\n          setSelectedNodes([\n            ...selectedNodes.slice(0, index),\n            ...selectedNodes.slice(index + 1)\n          ]);\n        } else {\n          setSelectedNodes(_.compact([...selectedNodes, currentNode.id]));\n        }\n      } else {\n        setSelectedNodes([currentNode.id]);\n      }\n    } else {\n      setSelectedNodes([currentNode.id]);\n      // 清空高亮的连线\n      setSelectedLinks(null);\n    }\n  };\n\n  /** 被连线的节点 */\n  onSelectNode = (currentNode: Node, key: OperateType) => {\n    const { selectedNodes, deleteNodes } = this.props;\n    if (key === OperateType.delete) {\n      // 删除组件以及删除连线\n      // 判断改节点是否在多选区域内\n      if (selectedNodes && selectedNodes.includes(currentNode.id)) {\n        deleteNodes(_.compact([...selectedNodes, currentNode.id]));\n      } else {\n        deleteNodes([currentNode.id]);\n      }\n    }\n  };\n\n  /** 右键连线 */\n  onContextMenuLink = (\n    key: string,\n    event: React.MouseEvent<SVGPathElement, MouseEvent>\n  ) => {\n    event.preventDefault();\n    event.stopPropagation();\n    this.props.setSelectedLinks([key]);\n    // 清空高亮的组件\n    this.props.setSelectedNodes(null);\n\n    const currentPos = {\n      x: event.clientX,\n      y: event.clientY\n    };\n    this.setState({\n      deleteVisible: true,\n      menuPos: currentPos\n    });\n  };\n\n  /** 伸缩节点 */\n  onResize = (\n    node: Node,\n    width: number,\n    height: number,\n    x: number,\n    y: number\n  ) => {\n    const { updateNodes } = this.props;\n    const newNode = {\n      ...node,\n      width,\n      height,\n      x,\n      y\n    };\n    updateNodes(newNode);\n  };\n  // 渲染节点内容\n  renderCanvas = () => {\n    const { currentHoverNode } = this.state;\n    const { nodes, links, selectedNodes, selectedLinks, groups } = this.props;\n    return (\n      <div className=\"editor-view\">\n        <div className=\"editor-view-content\" ref={this.nodesContainerRef}>\n          {(nodes || []).map(child => {\n            const id = child?.id;\n            const isSelected = selectedNodes\n              ? selectedNodes.includes(id)\n              : false;\n            const showSelector = isSelected || currentHoverNode === id;\n            return (\n              <EditorNode\n                nodeRef={child.ref}\n                currentNode={child}\n                key={id}\n                onClick={this.onClickNode}\n                isSelected={isSelected}\n                showSelector={showSelector}\n                onResize={this.onResize.bind(this, child)}\n                currTrans={this.props.currTrans}\n                onSelect={this.onSelectNode}\n              />\n            );\n          })}\n\n          {(groups || []).map(child => {\n            const id = child?.id;\n            const nodesInGroup = child?.nodes;\n            return (\n              <EditorGroup\n                key={id}\n                id={id}\n                groupRef={child?.ref}\n                currentGroup={child}\n                nodes={nodesInGroup}\n              />\n            );\n          })}\n\n          <EditorEdges\n            links={links}\n            nodes={nodes}\n            selectedLinks={selectedLinks}\n            onContextMenu={this.onContextMenuLink}\n            onSelectLink={this.onSelectLink}\n            isDraggingLink={this.state.isDraggingLink}\n            dragLink={this.state.dragLink}\n          />\n        </div>\n      </div>\n    );\n  };\n\n  render() {\n    const { deleteVisible, menuPos } = this.state;\n    return (\n      <div className=\"canvas-container-content\" ref={this.container}>\n        <ReScreen\n          type=\"DOM\"\n          getScreenHandler={this.getScreenHandler}\n          needMinimap={true}\n          needRefresh={true}\n          zoomEnabled={false}\n          mapPosition=\"RT\"\n          mapWidth={200}\n          mapHeight={300}\n          height={500}\n          width={800}\n          screenHeight={900}\n          screenWidth={600}\n          mapRectStyle={{\n            stroke: \"#468CFF\",\n            fill: \"transparent\",\n            strokeWidth: 1.5\n          }}\n          focusEnabled={2}\n          onScreenChange={this.getTransformInfo}\n          onDragOver={event => {\n            event.preventDefault();\n          }}\n          onDrop={this.onDrop.bind(this)}\n        >\n          {this.renderCanvas()}\n        </ReScreen>\n        {/** 删除连线的菜单 */}\n        <ContextMenu\n          visible={deleteVisible}\n          // onHide={() => {\n          //   this.props.setLinks(null);\n          //   this.setState({\n          //     deleteVisible: false\n          //   });\n          // }}\n          left={menuPos.x}\n          top={menuPos.y}\n          // onClick={this.handleDeleteLinks.bind(this, selectedLinks)}\n        >\n          <Menu\n            getPopupContainer={(triggerNode: any) => triggerNode.parentNode}\n          >\n            {[\n              {\n                name: \"删除\",\n                key: OperateType.delete\n              }\n            ].map(child => {\n              return <Menu.Item key={child.key}>{child.name}</Menu.Item>;\n            })}\n          </Menu>\n        </ContextMenu>\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}